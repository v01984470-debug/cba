<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Investigation Report - CBA POC</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
        background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
        min-height: 100vh;
        padding: 20px 10px;
      }

      .container {
        width: 100%;
        margin: 0;
        background: #ffffff;
        border-radius: 12px;
        box-shadow: none;
        overflow: hidden;
      }

      .header {
        background: linear-gradient(135deg, #000000 0%, #1a1a1a 100%);
        color: #ffd700;
        padding: 30px 48px;
        display: flex;
        flex-direction: column;
        align-items: flex-start;
        border-bottom: 3px solid #ffd700;
        margin-top: 0;
      }

      .header-top {
        display: flex;
        justify-content: space-between;
        align-items: center;
        width: 100%;
        margin-bottom: 8px;
      }

      .header h1 {
        font-size: 2.4rem;
        margin: 0;
        font-weight: 600;
        letter-spacing: 0.2px;
      }

      .back-button {
        background: #ffd700;
        color: #000000;
        border: none;
        padding: 10px 20px;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.3s ease;
        display: inline-flex;
        align-items: center;
        gap: 8px;
      }

      .back-button:hover {
        background: #ffed4e;
        transform: translateY(-2px);
        box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
      }

      .case-id-badge {
        background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%);
        color: #000000;
        padding: 12px 24px;
        border-radius: 8px;
        font-size: 16px;
        font-weight: 700;
        display: inline-block;
        margin-top: 16px;
        box-shadow: 0 4px 12px rgba(255, 215, 0, 0.3);
      }

      .agent-processing-header {
        background: transparent;
        color: #ffd700;
        padding: 5px 0;
        text-align: left;
        margin-bottom: 0px;
      }

      .agent-processing-header h2 {
        font-size: 1.5rem;
        margin-bottom: 2px;
        font-weight: 600;
        letter-spacing: 0.2px;
      }

      .agent-processing-header p {
        opacity: 0.85;
        font-size: 1rem;
        margin-bottom: 0px;
      }

      .agent-processing-header h3 {
        font-size: 1.2rem;
        font-weight: 500;
        margin-top: 8px;
        margin-bottom: 0px;
        color: #ffd700;
        opacity: 0.9;
      }

      /* Agent Flow Section Styles - Full Width */
      .agent-flow-section {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin: 0;
        padding: 10px 40px 56px 40px;
        background: #ffffff;
        width: 100% !important;
        max-width: none !important;
        box-sizing: border-box;
      }

      .agent-step {
        background: rgba(0, 0, 0, 0.1);
        border-radius: 8px;
        padding: 15px;
        border: 2px solid #ffd700;
        transition: all 0.5s ease;
        opacity: 0.8;
        transform: translateX(0);
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 10px;
        position: relative;
      }

      .agent-step.completed {
        opacity: 0.8;
        border-color: #28a745;
        background: rgba(0, 0, 0, 0.2);
      }

      .step-header {
        display: flex;
        align-items: center;
        gap: 10px;
        margin-bottom: 10px;
        position: relative;
      }

      .step-icon {
        width: 35px;
        height: 35px;
        border-radius: 50%;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 1.2rem;
        background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        color: white;
      }

      .agent-step.completed .step-icon {
        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
        color: #fff;
      }

      .step-title {
        font-size: 1.1rem;
        font-weight: 600;
        color: #2c3e50;
        flex-grow: 1;
      }

      .step-status {
        padding: 4px 12px;
        border-radius: 15px;
        font-size: 0.8rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        background: #28a745;
        color: white;
      }

      .step-content {
        margin-top: 10px;
      }

      .step-content p {
        font-size: 1rem;
        color: #2c3e50;
        font-weight: 500;
        margin-bottom: 10px;
      }

      .agent-flow-section h3 {
        margin: 0;
        padding: 0;
        color: #000000;
        font-family: "Times New Roman", Times, serif;
        font-weight: bold;
        font-size: 1.2rem;
      }

      /* Case Data Grid Styles - Full Width */
      .case-data-section {
        background: rgba(0, 0, 0, 0.05);
        border-radius: 6px;
        padding: 10px;
        margin-top: 10px;
        border-left: 3px solid #ffd700;
        font-family: "Courier New", monospace;
        font-size: 0.8rem;
        line-height: 1.3;
        max-height: 300px;
        overflow: hidden;
        transition: max-height 0.5s ease, padding 0.5s ease;
        color: #212529;
        width: 100% !important;
        box-sizing: border-box;
      }

      .case-data-section h4 {
        margin: 0 0 10px 0;
        color: #2c3e50;
        font-size: 1rem;
        font-weight: 600;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      .case-data-grid {
        display: block;
      }

      .data-row {
        display: block;
        margin: 2px 0;
        padding: 0;
        border: none;
        font-family: "Courier New", monospace;
        font-size: 0.8rem;
        line-height: 1.3;
      }

      .data-label {
        font-weight: 600;
        color: #212529;
        display: inline;
        margin-right: 5px;
      }

      .data-value {
        color: #212529;
        font-family: "Courier New", monospace;
        font-size: 0.8rem;
        background: none;
        padding: 0;
        border: none;
        box-shadow: none;
        font-weight: normal;
        display: inline;
      }

      .agent-output {
        background: rgba(0, 0, 0, 0.05);
        border-radius: 6px;
        padding: 10px;
        margin-top: 10px;
        border-left: 3px solid #ffd700;
        font-family: "Courier New", monospace;
        font-size: 0.8rem;
        line-height: 1.3;
        max-height: 300px;
        overflow: hidden;
        transition: max-height 0.5s ease, padding 0.5s ease;
        color: #212529;
        width: 100% !important;
        box-sizing: border-box;
      }

      .agent-output h4 {
        margin: 0 0 10px 0;
        color: #2c3e50;
        font-size: 1rem;
        font-weight: 600;
        font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
      }

      .output-content p {
        margin: 5px 0;
        color: #212529;
        font-weight: normal;
        font-size: 0.8rem;
        font-family: "Courier New", monospace;
        line-height: 1.3;
      }

      .agent-progress-bar {
        display: flex;
        align-items: center;
        justify-content: center;
        position: relative;
        max-width: 1200px;
        margin: 0 auto;
        padding: 10px 0;
      }

      .progress-bar-card {
        background: #808080;
        border-radius: 12px;
        padding: 20px 30px;
        box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        border: 2px solid #ffd700;
        margin: 0 -40px;
        width: calc(100% + 80px);
        box-sizing: border-box;
      }

      .cylindrical-progress-container {
        position: relative;
        width: 100%;
        height: 50px;
        background: #ffffff;
        border-radius: 25px;
        overflow: visible;
        display: flex;
        align-items: center;
        justify-content: space-between;
        padding: 0 30px;
        box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        margin-bottom: 10px;
      }

      .cylindrical-progress-fill {
        position: absolute;
        top: 0;
        left: 0;
        height: 100%;
        background: linear-gradient(90deg, #ffd700 0%, #ffed4e 100%);
        border-radius: 25px;
        transition: width 0.8s ease;
        overflow: hidden;
        width: 0%;
        z-index: 1;
      }

      .progress-step {
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        position: relative;
        z-index: 3;
        transition: all 0.3s ease;
        cursor: pointer;
        width: 80px;
        height: 50px;
        margin: 0 25px;
      }

      .progress-step:hover .step-number {
        transform: scale(1.1);
      }

      .step-number {
        width: 45px;
        height: 45px;
        border-radius: 50%;
        background: #000000;
        color: #ffd700;
        display: flex;
        align-items: center;
        justify-content: center;
        font-weight: bold;
        font-size: 18px;
        transition: all 0.3s ease;
        border: 2px solid #ffd700;
        position: relative;
        z-index: 4;
        margin-bottom: 5px;
        margin-top: 2.5px;
      }

      .progress-step.active .step-number {
        background: #ffd700;
        color: #000000;
        border: 4px solid #000000;
        transform: scale(1.25);
        font-weight: 900;
        width: 50px;
        height: 50px;
        font-size: 20px;
      }

      .progress-step.completed .step-number {
        background: #000000;
        color: #ffd700;
        border-color: #ffd700;
      }

      .progress-step.completed.active .step-number {
        background: #ffd700;
        color: #000000;
        border: 4px solid #000000;
        transform: scale(1.25);
        font-weight: 900;
        width: 50px;
        height: 50px;
        font-size: 20px;
      }

      .step-label {
        font-size: 8px;
        font-weight: 600;
        color: #ffd700;
        text-align: center;
        transition: all 0.3s ease;
        text-transform: uppercase;
        letter-spacing: 0.2px;
        white-space: nowrap;
        line-height: 1.1;
        position: absolute;
        bottom: -20px;
        left: 50%;
        transform: translateX(-50%);
        width: 120px;
      }

      .progress-step.completed .step-label {
        color: #ffd700;
      }

      .progress-step.active .step-label {
        color: #000000;
        background: #ffd700;
        padding: 2px 6px;
        border-radius: 4px;
        font-weight: 700;
      }

      .progress-step.disabled {
        opacity: 0.5;
        cursor: not-allowed;
        pointer-events: none;
      }

      .progress-step.disabled .step-number {
        background: #666666;
        color: #999999;
      }

      .progress-step.disabled .step-label {
        color: #999999;
      }

      .back-btn {
        background: rgba(255, 215, 0, 0.2);
        color: #ffd700;
        border: 1px solid rgba(255, 215, 0, 0.5);
        padding: 10px 20px;
        border-radius: 8px;
        text-decoration: none;
        transition: all 0.3s ease;
      }

      .back-btn:hover {
        background: rgba(255, 215, 0, 0.3);
        color: #ffffff;
      }

      .content {
        padding: 30px;
      }

      /* Status chips */
      .chip {
        display: inline-block;
        padding: 2px 8px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
      }
      .chip-pass {
        background: #e6f4ea;
        color: #137333;
        border: 1px solid #c7ebd3;
      }
      .chip-fail {
        background: #fde8e7;
        color: #a11a1a;
        border: 1px solid #f6c2bf;
      }
      .chip-info {
        background: #fff8dc;
        color: #b8860b;
        border: 1px solid #ffd700;
      }
      .kv-grid {
        display: grid;
        grid-template-columns: 180px 1fr;
        row-gap: 8px;
        column-gap: 14px;
      }

      /* Hide legacy detailed sections when tabs are enabled */
      .legacy {
        display: none;
      }

      /* Tabs */
      .tabs {
        display: flex;
        gap: 10px;
        border-bottom: 1px solid #e9ecef;
        margin: 0 0 10px 0;
      }
      .tab-btn {
        appearance: none;
        border: none;
        background: #2f2f2f;
        color: #ffd700;
        padding: 10px 14px;
        border-radius: 8px 8px 0 0;
        font-weight: 600;
        cursor: pointer;
      }
      .tab-btn.active {
        background: #ffd700;
        color: #000000;
        border: 1px solid #ffd700;
        border-bottom: 0;
      }
      .tab-panel {
        display: none;
        padding: 12px 0 0 0;
      }
      .tab-panel.active {
        display: block;
      }

      /* Account Operations Styles */
      .account-operations-grid {
        display: grid;
        grid-template-columns: repeat(2, minmax(360px, 1fr));
        gap: 20px;
        margin-top: 20px;
        width: 100%;
        box-sizing: border-box;
      }

      @media (max-width: 900px) {
        .account-operations-grid {
          grid-template-columns: 1fr;
        }
      }

      .operation-card {
        background: #fefef8;
        border-radius: 12px;
        padding: 20px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        border-left: 4px solid #ddd;
      }

      .operation-card.debit {
        border-left-color: #dc3545; /* Debit as red */
        background: #fefef8;
      }

      .operation-card.credit {
        border-left-color: #28a745; /* Credit as green */
        background: #fefef8;
      }

      .operation-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 15px;
        padding-bottom: 10px;
        border-bottom: 1px solid #eee;
      }

      .operation-type {
        font-weight: bold;
        font-size: 14px;
        padding: 4px 8px;
        border-radius: 4px;
        color: white;
      }

      .operation-card.debit .operation-type {
        background: #dc3545; /* Debit badge red */
        color: #ffffff;
      }

      .operation-card.credit .operation-type {
        background: #28a745; /* Credit badge green */
        color: #ffffff;
      }

      .operation-amount {
        font-size: 18px;
        font-weight: bold;
        color: #2c3e50;
      }

      .operation-details {
        display: grid;
        gap: 15px;
      }

      .account-info {
        background: #f8f9fa;
        padding: 10px;
        border-radius: 6px;
      }

      .balance-info {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 10px;
      }

      .balance-row {
        display: flex;
        justify-content: space-between;
        padding: 5px 0;
      }

      .balance-label {
        font-weight: 500;
        color: #666;
      }

      .balance-value {
        font-weight: bold;
        color: #2c3e50;
      }

      .operation-reference {
        background: #e9ecef;
        padding: 8px;
        border-radius: 4px;
        font-size: 12px;
        color: #666;
      }

      .no-operations {
        text-align: center;
        padding: 40px;
        color: #666;
        background: #f8f9fa;
        border-radius: 8px;
        margin-top: 20px;
      }

      .summary-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
        gap: 24px;
        margin-bottom: 40px;
      }

      .summary-card {
        background: #fefef8;
        border-radius: 12px;
        padding: 24px;
        border: 1px solid #ffd700;
      }

      .summary-card h3 {
        color: #2c3e50;
        margin-bottom: 16px;
        font-size: 1.2rem;
        display: flex;
        align-items: center;
        gap: 8px;
      }

      .summary-card h3::before {
        content: "üìä";
        font-size: 1.1rem;
      }

      .info-row {
        display: flex;
        justify-content: space-between;
        padding: 8px 0;
        border-bottom: 1px solid #e9ecef;
      }

      .info-row:last-child {
        border-bottom: none;
      }

      .info-label {
        font-weight: 600;
        color: #495057;
      }

      .info-value {
        color: #2c3e50;
        text-align: right;
      }

      .status-badge {
        padding: 4px 12px;
        border-radius: 20px;
        font-size: 0.85rem;
        font-weight: 600;
      }

      .status-success {
        background: #d4edda;
        color: #155724;
      }

      .status-warning {
        background: #fff3cd;
        color: #856404;
      }

      .status-danger {
        background: #f8d7da;
        color: #721c24;
      }

      .status-info {
        background: #fff8dc;
        color: #b8860b;
      }

      .section {
        background: #fefef8;
        border-radius: 12px;
        padding: 24px;
        margin-bottom: 24px;
        border: 1px solid #ffd700;
      }

      .section h3 {
        color: #2c3e50;
        margin-bottom: 20px;
        font-size: 1.3rem;
        display: flex;
        align-items: center;
        gap: 10px;
      }

      .section h3::before {
        content: "üîç";
        font-size: 1.2rem;
      }

      .eligibility-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 12px;
      }

      .eligibility-item {
        background: #fefef8;
        padding: 12px;
        border-radius: 10px;
        border: 1px solid #e5e7eb;
        display: flex;
        flex-direction: column;
        align-items: center;
        gap: 6px;
      }

      .eligibility-item.pass {
        background: #fefef8;
        border-color: #e5e7eb;
      }

      .eligibility-item.fail {
        background: #fefef8;
        border-color: #e5e7eb;
      }

      .eligibility-item.info {
        background: #fefef8;
        border-color: #e5e7eb;
      }

      .eligibility-item h4 {
        margin: 0;
        color: #2c3e50;
        font-size: 13px;
        font-weight: 600;
        text-align: center;
        width: 100%;
      }
      .eligibility-item p { display: none; }
      .eligibility-item .status-badge { margin-top: 2px; }

      .verification-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 16px;
      }

      /* 3-up layout specifically for Processing Outcomes */
      .outcomes-grid {
        display: grid;
        grid-template-columns: repeat(3, minmax(240px, 1fr));
        gap: 16px;
        align-items: stretch;
      }
      .outcomes-grid .verification-item {
        background: #fff8dc;
        border: 1px solid #ffd700;
        border-radius: 10px;
        padding: 12px;
        display: flex;
        flex-direction: column;
        justify-content: flex-start;
        gap: 8px;
      }

      /* Interactive Graph Tooltips */
      .graph-tooltip {
        position: fixed;
        display: none;
        z-index: 10000;
        background: #ffffff;
        color: #2c3e50;
        border: 1px solid #ffd700;
        box-shadow: 0 8px 24px rgba(0,0,0,0.12);
        border-radius: 10px;
        min-width: 280px;
        max-width: 400px;
        padding: 16px;
        pointer-events: none;
      }
      .graph-tooltip h4 { 
        font-weight: 700; 
        margin-bottom: 12px; 
        color: #ffd700;
        font-size: 16px;
      }
      .graph-tooltip .data-row { 
        display: flex; 
        justify-content: space-between; 
        padding: 6px 0;
        border-bottom: 1px solid #f0f0f0;
      }
      .graph-tooltip .data-row:last-child {
        border-bottom: none;
      }
      .graph-tooltip .data-label {
        font-weight: 600;
        color: #666;
        font-size: 13px;
      }
      .graph-tooltip .data-value {
        color: #2c3e50;
        font-size: 13px;
        text-align: right;
      }
      
      /* Agentic Graph Styles */
      .agentic-graph-container {
        background: #fafafa;
        border: 1px solid #e0e0e0;
        border-radius: 12px;
        padding: 20px;
        margin-top: 20px;
        overflow-x: auto;
        overflow-y: hidden;
      }
      
      .agentic-graph {
        display: flex;
        align-items: center;
        gap: 20px;
        min-width: 1200px;
        padding: 20px 0;
      }
      
      .agent-node {
        background: white;
        border: 2px solid #ffd700;
        border-radius: 12px;
        padding: 0;
        min-width: 180px;
        cursor: pointer;
        transition: all 0.3s ease;
        box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        position: relative;
        flex-shrink: 0;
      }
      
      .agent-node.main-agent {
        min-width: 220px;
        border-color: #000;
        border-width: 3px;
      }
      
      .agent-node:hover {
        transform: translateY(-3px);
        box-shadow: 0 8px 20px rgba(255,215,0,0.4);
        border-color: #000;
      }
      
      .node-content {
        padding: 16px;
        text-align: center;
      }
      
      .agent-icon {
        font-size: 32px;
        margin-bottom: 8px;
        display: block;
      }
      
      .agent-info h4 {
        font-size: 14px;
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 4px;
        line-height: 1.2;
      }
      
      .agent-info p {
        font-size: 11px;
        color: #666;
        margin: 0;
        line-height: 1.3;
      }
      
      .agent-status {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #28a745;
        color: white;
        border-radius: 50%;
        width: 24px;
        height: 24px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 12px;
        font-weight: bold;
        box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      }
      
      /* Sub-agents for Actioning Agent */
      .sub-agents-container {
        display: flex;
        justify-content: space-around;
        padding: 12px 8px 8px 8px;
        background: #f8f9fa;
        border-top: 1px solid #e0e0e0;
        border-radius: 0 0 10px 10px;
        gap: 4px;
      }
      
      .sub-agent {
        display: flex;
        flex-direction: column;
        align-items: center;
        padding: 6px 4px;
        background: white;
        border-radius: 6px;
        border: 1px solid #ddd;
        cursor: pointer;
        transition: all 0.2s ease;
        min-width: 40px;
      }
      
      .sub-agent:hover {
        background: #ffd700;
        border-color: #000;
        transform: scale(1.05);
      }
      
      .sub-icon {
        font-size: 16px;
        margin-bottom: 2px;
      }
      
      .sub-label {
        font-size: 9px;
        color: #666;
        font-weight: 500;
        text-align: center;
        line-height: 1;
      }
      
      /* Flow Arrows */
      .flow-arrow {
        display: flex;
        align-items: center;
        justify-content: center;
        flex-shrink: 0;
      }
      
      .flow-arrow svg {
        filter: drop-shadow(0 1px 2px rgba(0,0,0,0.1));
      }

      .verification-item {
        background: white;
        padding: 16px;
        border-radius: 8px;
        display: flex;
        align-items: center;
        gap: 12px;
        border: 1px solid #e5e7eb;
      }

      .verification-item.pass {
        border: 1px solid #cce8d6;
      }

      .verification-item.fail {
        border: 1px solid #f5c6cb;
      }

      .verification-icon {
        font-size: 1.5rem;
      }

      .communication-item {
        background: white;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 12px;
        border: 1px solid #e5e7eb;
      }

      .audit-timeline {
        position: relative;
        padding-left: 30px;
      }

      .audit-timeline::before {
        content: "";
        position: absolute;
        left: 15px;
        top: 0;
        bottom: 0;
        width: 2px;
        background: #dee2e6;
      }

      .audit-item {
        position: relative;
        background: white;
        padding: 16px;
        border-radius: 8px;
        margin-bottom: 16px;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .audit-item::before {
        content: "";
        position: absolute;
        left: -22px;
        top: 20px;
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background: #ffd700;
        border: 3px solid white;
        box-shadow: 0 0 0 2px #dee2e6;
      }

      .audit-time {
        font-size: 0.85rem;
        color: #6c757d;
        margin-bottom: 4px;
      }

      .audit-actor {
        font-weight: 600;
        color: #2c3e50;
        margin-bottom: 4px;
      }

      .audit-action {
        color: #495057;
      }

      .decision-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        text-align: center;
        border: 2px solid;
      }

      .decision-card.processed {
        border-color: #28a745;
        background: linear-gradient(135deg, #d4edda 0%, #c3e6cb 100%);
      }

      .decision-card.pending {
        border-color: #ffc107;
        background: linear-gradient(135deg, #fff3cd 0%, #ffeaa7 100%);
      }

      .decision-card.failed {
        border-color: #dc3545;
        background: linear-gradient(135deg, #f8d7da 0%, #f5c6cb 100%);
      }

      .decision-icon {
        font-size: 3rem;
        margin-bottom: 16px;
      }

      .decision-title {
        font-size: 1.5rem;
        font-weight: 600;
        margin-bottom: 8px;
      }

      .decision-details {
        color: #6c757d;
      }

      /* Enhanced Refund Styles */
      .enhanced-refund-card {
        background: white;
        border-radius: 12px;
        padding: 24px;
        border: 2px solid #ffd700;
        background: linear-gradient(135deg, #fff8dc 0%, #ffd700 100%);
      }

      .enhanced-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 2px solid #ffd700;
      }

      .enhanced-header h4 {
        color: #2c3e50;
        margin: 0;
        font-size: 1.3rem;
      }

      .status-badge {
        padding: 8px 16px;
        border-radius: 20px;
        font-weight: bold;
        font-size: 0.9rem;
      }

      .status-badge.success {
        background: #d4edda;
        color: #155724;
        border: 1px solid #c3e6cb;
      }

      .status-badge.error {
        background: #f8d7da;
        color: #721c24;
        border: 1px solid #f5c6cb;
      }

      .processing-step {
        background: rgba(255, 255, 255, 0.7);
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        border: 1px solid #e5e7eb;
      }

      /* Enhanced Agent Modal Styles */
      .verification-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
        gap: 12px;
        margin: 16px 0;
      }

      .verification-item {
        background: #fefef8;
        border-radius: 8px;
        padding: 12px;
        border: 1px solid #e5e7eb;
      }

      .verification-value {
        color: #2c3e50;
        font-weight: 600;
        margin-left: 8px;
      }

      .enhanced-flow {
        background: #fefef8;
        border-radius: 12px;
        padding: 20px;
        margin: 16px 0;
        border: 1px solid #e5e7eb;
      }

      .flow-step {
        background: #fefef8;
        border-radius: 8px;
        padding: 16px;
        margin-bottom: 12px;
        border: 1px solid #e5e7eb;
        box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
      }

      .flow-step:last-child {
        margin-bottom: 0;
      }

      .step-title {
        color: #2c3e50;
        font-weight: 600;
        margin-left: 8px;
      }

      .step-detail {
        color: #6c757d;
        font-size: 0.9rem;
        margin-top: 4px;
        margin-left: 20px;
      }

      .message-templates {
        background: #fefef8;
        border-radius: 8px;
        padding: 16px;
        margin: 16px 0;
        border: 1px solid #e5e7eb;
      }

      .template-item {
        background: #fefef8;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 8px;
        border: 1px solid #e5e7eb;
      }

      .template-content {
        color: #495057;
        font-style: italic;
        margin-top: 4px;
        padding: 8px;
        background: #f8f9fa;
        border-radius: 4px;
      }

      .audit-events {
        background: #fefef8;
        border-radius: 8px;
        padding: 16px;
        margin: 16px 0;
        border: 1px solid #e5e7eb;
      }

      .audit-event {
        background: #fefef8;
        border-radius: 6px;
        padding: 12px;
        margin-bottom: 8px;
        border: 1px solid #e5e7eb;
      }

      .event-status {
        color: #28a745;
        font-weight: 600;
        margin-left: 8px;
      }

      .event-detail {
        color: #6c757d;
        font-size: 0.9rem;
        margin-top: 4px;
        margin-left: 20px;
      }

      .processing-step h5 {
        color: #2c3e50;
        margin: 0 0 10px 0;
        font-size: 1.1rem;
      }

      .processing-step p {
        margin: 5px 0;
        color: #495057;
      }
    </style>
  </head>
  <body>
    <div class="container">

      <div class="header">
        <div class="header-top">
          <h1>Payment Refund Investigations</h1>
          <button class="back-button" onclick="window.location.href='/'">
            ‚Üê Back to Investigation
          </button>
        </div>
        <p>Intelligent Payment Processing System</p>
        <div class="case-id-badge" id="case-id-badge">
          Case ID: <span id="case-id-display">Loading...</span>
        </div>
      </div>

      <!-- Agent Progress Bar -->
      <div class="progress-bar-card">
        <div class="agent-progress-bar">
          <div class="cylindrical-progress-container">
            <div class="cylindrical-progress-fill" id="cylindricalProgressFill"></div>
            <div class="progress-step" id="step-1" onclick="showLoggerContent()">
              <div class="step-number">1</div>
              <div class="step-label">Case Investigation Starts</div>
            </div>
            <div class="progress-step" id="step-2" onclick="showInvestigatorContent()">
              <div class="step-number">2</div>
              <div class="step-label">Investigator Agent</div>
            </div>
            <div class="progress-step" id="step-3" onclick="showVerifierContent()">
              <div class="step-number">3</div>
              <div class="step-label">Verifier Agent</div>
            </div>
            <div class="progress-step" id="step-4" onclick="showCommunicationsContent()">
              <div class="step-number">4</div>
              <div class="step-label">Communications Agent</div>
            </div>
            <div class="progress-step" id="step-5" onclick="showInvestigationReport()">
              <div class="step-number">5</div>
              <div class="step-label">Investigation Report</div>
            </div>
            <div class="progress-step" id="step-6" onclick="showCaseFinalStatus()">
              <div class="step-number">6</div>
              <div class="step-label">Case Final Status</div>
            </div>
          </div>
        </div>
      </div>
      
        <!-- Logger Agent Flow Content -->
        <div id="loggerContent" style="display: none; margin: 20px -40px 0 -40px; width: calc(100% + 80px);">
          <div class="agent-flow-section" style="width: calc(100% - 40px) !important; margin: 0 20px; padding: 50px 40px 56px 40px; background: #ffffff; box-sizing: border-box;">
            <h3 style="margin-top: 10px; padding-top: 0;">üìù Logger Agent Processing</h3>
            <div class="agent-step" style="width: 100%;">
              <div class="step-header">
                <span class="step-icon">üìù</span>
                <span class="step-title">Logger Agent</span>
                <span class="step-status completed">‚úì Completed</span>
              </div>
              <div class="step-content">
                <p><strong>Logger Agent prepares the case for processing by creating audit logs and initializing the workflow...</strong></p>
                
                <!-- Logger Agent Data -->
                <div class="case-data-section" style="width: 100%; background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                  <h4 style="color: #000000; font-weight: bold; margin-bottom: 15px;">üìã Logger Agent Output</h4>
                  <div class="case-data-grid" style="width: 100%;">
                    <div class="data-row">
                      <span class="data-label">Case ID:</span>
                      <span class="data-value">{{ result.transaction_id if result.transaction_id else 'Unknown' }}</span>
                    </div>
                    <div class="data-row">
                      <span class="data-label">UETR:</span>
                      <span class="data-value">{{ result.uetr if result.uetr else (result.parsed_data.pacs004.uetr if result.parsed_data and result.parsed_data.pacs004 and result.parsed_data.pacs004.uetr else 'Unknown') }}</span>
                    </div>
                    <div class="data-row">
                      <span class="data-label">E2E ID:</span>
                      <span class="data-value">{{ result.transaction_id if result.transaction_id else (result.parsed_data.pacs004.e2e if result.parsed_data and result.parsed_data.pacs004 and result.parsed_data.pacs004.e2e else 'Unknown') }}</span>
                    </div>
                    <div class="data-row">
                      <span class="data-label">Debtor Name:</span>
                      <span class="data-value">{{ result.parsed_data.pacs008.dbtr_name if result.parsed_data and result.parsed_data.pacs008 and result.parsed_data.pacs008.dbtr_name else 'Unknown' }}</span>
                    </div>
                    <div class="data-row">
                      <span class="data-label">Debtor IBAN:</span>
                      <span class="data-value">{{ result.parsed_data.pacs008.dbtr_iban if result.parsed_data and result.parsed_data.pacs008 and result.parsed_data.pacs008.dbtr_iban else 'Unknown' }}</span>
                    </div>
                    <div class="data-row">
                      <span class="data-label">Amount:</span>
                      <span class="data-value">{{ result.parsed_data.pacs004.rtr_amount if result.parsed_data and result.parsed_data.pacs004 and result.parsed_data.pacs004.rtr_amount else 'Unknown' }} {{ result.parsed_data.pacs004.rtr_ccy if result.parsed_data and result.parsed_data.pacs004 and result.parsed_data.pacs004.rtr_ccy else '' }}</span>
                    </div>
                    <div class="data-row">
                      <span class="data-label">Return Reason:</span>
                      <span class="data-value">{{ result.parsed_data.pacs004.rsn if result.parsed_data and result.parsed_data.pacs004 and result.parsed_data.pacs004.rsn else 'Unknown' }}</span>
                    </div>
                    <div class="data-row">
                      <span class="data-label">Reason Info:</span>
                      <span class="data-value">{{ result.parsed_data.pacs004.rsn_info if result.parsed_data and result.parsed_data.pacs004 and result.parsed_data.pacs004.rsn_info else 'Unknown' }}</span>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Investigator Agent Flow Content -->
        <div id="investigatorContent" style="display: none; margin: 20px -40px 0 -40px; width: calc(100% + 80px);">
          <div class="agent-flow-section" style="width: calc(100% - 40px) !important; margin: 0 20px; padding: 50px 40px 56px 40px; background: #ffffff; box-sizing: border-box;">
            <h3 style="margin-top: 10px; padding-top: 0;">üîç Investigator Agent Processing</h3>
            <div class="agent-step" style="width: 100%;">
              <div class="step-header">
                <span class="step-icon">üîç</span>
                <span class="step-title">Investigator Agent</span>
                <span class="step-status completed">‚úì Completed</span>
              </div>
              <div class="step-content">
                <p><strong>Analyzing payment data and determining eligibility...</strong></p>
                
                <div class="case-data-section" style="width: 100%;">
                  <h4>üìã Investigation Agent Results:</h4>
                  <div class="case-data-grid" style="width: 100%;">
                    <div class="data-row">
                      <span class="data-label">UETR:</span>
                      <span class="data-value">{{ result.uetr if result.uetr else (result.parsed_data.pacs004.uetr if result.parsed_data and result.parsed_data.pacs004 and result.parsed_data.pacs004.uetr else 'abc12345-e89b-12d3-a456-426614174abc') }}</span>
                    </div>
                    <div class="data-row">
                      <span class="data-label">E2E ID:</span>
                      <span class="data-value">{{ result.transaction_id if result.transaction_id else (result.parsed_data.pacs004.e2e if result.parsed_data and result.parsed_data.pacs004 and result.parsed_data.pacs004.e2e else 'E2EID-FCA-001') }}</span>
                    </div>
                    <div class="data-row">
                      <span class="data-label">IBAN:</span>
                      <span class="data-value">{{ result.parsed_data.pacs008.dbtr_iban if result.parsed_data and result.parsed_data.pacs008 and result.parsed_data.pacs008.dbtr_iban else 'DE89370400440532013000' }}</span>
                    </div>
                    <div class="data-row">
                      <span class="data-label">Return Reason:</span>
                      <span class="data-value">{{ result.investigation.eligibility.reason if result.investigation and result.investigation.eligibility and result.investigation.eligibility.reason else (result.parsed_data.pacs004.rsn if result.parsed_data and result.parsed_data.pacs004 and result.parsed_data.pacs004.rsn else 'AC04') }}</span>
                    </div>
                    <div class="data-row">
                      <span class="data-label">Reason Info:</span>
                      <span class="data-value">{{ result.investigation.eligibility.reason_info if result.investigation and result.investigation.eligibility and result.investigation.eligibility.reason_info else (result.parsed_data.pacs004.rsn_info if result.parsed_data and result.parsed_data.pacs004 and result.parsed_data.pacs004.rsn_info else 'Account closed') }}</span>
                    </div>
                    <div class="data-row">
                      <span class="data-label">Auto Refund Eligible:</span>
                      <span class="data-value">{{ 'Yes' if (result.investigation.eligibility.eligible_auto_refund if result.investigation and result.investigation.eligibility and result.investigation.eligibility.eligible_auto_refund is defined else False) else 'No' }}</span>
                    </div>
                    <div class="data-row">
                      <span class="data-label">Customer Valid:</span>
                      <span class="data-value">{{ 'Yes' if (result.investigation.csv_validation.ok if result.investigation and result.investigation.csv_validation and result.investigation.csv_validation.ok is defined else False) else 'No' }}</span>
                    </div>
                    <div class="data-row">
                      <span class="data-label">Cross Checks:</span>
                      <span class="data-value">{{ 'OK' if (result.investigation.cross_errors | length == 0 if result.investigation and result.investigation.cross_errors else True) else ('Failed (' + (result.investigation.cross_errors | length) | string + ' errors)') }}</span>
                    </div>
                    <div class="data-row">
                      <span class="data-label">Currency Mismatch:</span>
                      <span class="data-value">{{ 'Yes' if (result.investigation.eligibility.currency_mismatch if result.investigation and result.investigation.eligibility and result.investigation.eligibility.currency_mismatch is defined else False) else 'No' }}</span>
                    </div>
                  </div>
                </div>
                
                <div class="agent-output" style="width: 100%;">
                  <h4>üì§ Investigation Summary:</h4>
                  <div class="output-content" style="width: 100%;">
                    <p><strong>Investigation Status:</strong> 
                      {% if result.investigation and result.investigation.eligibility %}
                        {% if result.investigation.eligibility.eligible_auto_refund %}
                          Case eligible for automated refund processing
                        {% else %}
                          Case requires manual review
                        {% endif %}
                      {% else %}
                        Investigation in progress
                      {% endif %}
                    </p>
                    <p><strong>Next Step:</strong> 
                      {% if result.investigation and result.investigation.eligibility and result.investigation.eligibility.eligible_auto_refund %}
                        Proceed to Verifier Agent
                      {% else %}
                        Manual review required
                      {% endif %}
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Verifier Agent Flow Content -->
        <div id="verifierContent" style="display: none; margin: 20px -40px 0 -40px; width: calc(100% + 80px);">
          <div class="agent-flow-section" style="width: calc(100% - 40px) !important; margin: 0 20px; padding: 50px 40px 56px 40px; background: #ffffff; box-sizing: border-box;">
            <h3 style="margin-top: 10px; padding-top: 0;">‚öñÔ∏è Verifier Agent Processing</h3>
            <div class="agent-step" style="width: 100%;">
              <div class="step-header">
                <span class="step-icon">‚öñÔ∏è</span>
                <span class="step-title">Verifier Agent</span>
                <span class="step-status completed">‚úì Completed</span>
              </div>
              <div class="step-content">
                <p><strong>Verifying refund decision and determining final action...</strong></p>
                
                <div class="case-data-section" style="width: 100%;">
                  <h4>üìã Verifier Decision Results:</h4>
                  <div class="case-data-grid" style="width: 100%;">
                    <div class="data-row">
                      <span class="data-label">Decision:</span>
                      <span class="data-value">{{ result.verification.verifier_summary.decision if result.verification and result.verification.verifier_summary and result.verification.verifier_summary.decision else (result.refund_processing.refund_decision.can_process if result.refund_processing and result.refund_processing.refund_decision and result.refund_processing.refund_decision.can_process else 'Manual Review') }}</span>
                    </div>
                    <div class="data-row">
                      <span class="data-label">Reason:</span>
                      <span class="data-value">{{ result.verification.verifier_summary.decision_reason if result.verification and result.verification.verifier_summary and result.verification.verifier_summary.decision_reason else (result.refund_processing.refund_decision.reason if result.refund_processing and result.refund_processing.refund_decision and result.refund_processing.refund_decision.reason else 'All verification checks passed') }}</span>
                    </div>
                    <div class="data-row">
                      <span class="data-label">Can Process:</span>
                      <span class="data-value">{{ 'Yes' if (result.refund_processing and result.refund_processing.refund_decision and result.refund_processing.refund_decision.can_process) else 'No' }}</span>
                    </div>
                    <div class="data-row">
                      <span class="data-label">Final Action:</span>
                      <span class="data-value">{{ result.refund_processing.refund_decision.reason if result.refund_processing and result.refund_processing.refund_decision and result.refund_processing.refund_decision.reason else 'Refund approved' }}</span>
                    </div>
                  </div>
                </div>
                
                <div class="agent-output" style="width: 100%;">
                  <h4>üì§ Verification Summary:</h4>
                  <div class="output-content" style="width: 100%;">
                    <p><strong>Verification Status:</strong> 
                      {% set verifier_decision = result.verification.verifier_summary.decision if result.verification and result.verification.verifier_summary and result.verification.verifier_summary.decision else '' %}
                      {% if verifier_decision == 'approve_and_process' or (result.summary and result.summary.can_process) %}
                        ‚úÖ Decision: Approve and Process Refund
                      {% elif verifier_decision == 'resend_to_investigator' %}
                        ‚ùì Decision: Resend to Investigator for Clarification
                      {% elif verifier_decision == 'human_intervention' %}
                        üë§ Decision: Pass for Human Intervention
                      {% else %}
                        Verification completed
                      {% endif %}
                    </p>
                    <p><strong>Next Step:</strong> 
                      {% if verifier_decision == 'approve_and_process' or (result.summary and result.summary.can_process) %}
                        Proceed to Communications Agent
                      {% elif verifier_decision == 'resend_to_investigator' %}
                        Return to Investigator Agent
                      {% else %}
                        Manual review required
                      {% endif %}
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Communications Agent Flow Content -->
        <div id="communicationsContent" style="display: none; margin: 20px -40px 0 -40px; width: calc(100% + 80px);">
          <div class="agent-flow-section" style="width: calc(100% - 40px) !important; margin: 0 20px; padding: 50px 40px 56px 40px; background: #ffffff; box-sizing: border-box;">
            <h3 style="margin-top: 10px; padding-top: 0;">üìß Communications Agent Processing</h3>
            <div class="agent-step" style="width: 100%;">
              <div class="step-header">
                <span class="step-icon">üìß</span>
                <span class="step-title">Communications Agent</span>
                <span class="step-status completed">‚úì Completed</span>
              </div>
              <div class="step-content">
                <p><strong>Generating customer notifications and communications...</strong></p>
                
                <div class="case-data-section" style="width: 100%;">
                  <h4>üìã Communication Results:</h4>
                  <div class="case-data-grid" style="width: 100%;">
                    <div class="data-row">
                      <span class="data-label">Customer Name:</span>
                      <span class="data-value">{{ result.parsed_data.pacs008.dbtr_name if result.parsed_data and result.parsed_data.pacs008 and result.parsed_data.pacs008.dbtr_name else 'Unknown' }}</span>
                    </div>
                    <div class="data-row">
                      <span class="data-label">Customer IBAN:</span>
                      <span class="data-value">{{ result.parsed_data.pacs008.dbtr_iban if result.parsed_data and result.parsed_data.pacs008 and result.parsed_data.pacs008.dbtr_iban else 'Unknown' }}</span>
                    </div>
                    <div class="data-row">
                      <span class="data-label">Case Reference:</span>
                      <span class="data-value">{{ result.transaction_id if result.transaction_id else 'Unknown' }}</span>
                    </div>
                    <div class="data-row">
                      <span class="data-label">Amount:</span>
                      <span class="data-value">{{ result.parsed_data.pacs004.rtr_amount if result.parsed_data and result.parsed_data.pacs004 and result.parsed_data.pacs004.rtr_amount else 'Unknown' }} {{ result.parsed_data.pacs004.rtr_ccy if result.parsed_data and result.parsed_data.pacs004 and result.parsed_data.pacs004.rtr_ccy else '' }}</span>
                    </div>
                    <div class="data-row">
                      <span class="data-label">Communication Status:</span>
                      <span class="data-value">{% if result.communications and result.communications.communication_templates %}Templates Generated{% else %}Pending Generation{% endif %}</span>
                    </div>
                  </div>
                </div>
                
                <div class="agent-output" style="width: 100%;">
                  <h4>üì§ Communication Summary:</h4>
                  <div class="output-content" style="width: 100%;">
                    <p><strong>Communication Status:</strong> 
                      {% if result.communications and result.communications.email_payload %}
                        Customer notification prepared and ready for sending
                      {% else %}
                        Communication templates generated
                      {% endif %}
                    </p>
                    <p><strong>Next Step:</strong> 
                      {% if result.summary and result.summary.can_process %}
                        Proceed to Investigation Report
                      {% else %}
                        Case requires manual review
                      {% endif %}
                    </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Case Final Status Content -->
        <div id="caseFinalStatusContent" style="display: none; margin: 20px -40px 0 -40px; width: calc(100% + 80px);">
          <div class="agent-flow-section" style="width: calc(100% - 40px) !important; margin: 0 20px; padding: 50px 40px 56px 40px; background: #ffffff; box-sizing: border-box;">
            <h3 style="margin-top: 10px; padding-top: 0;">üìã Case Final Status</h3>
            <div class="agent-step" style="width: 100%;">
              <div class="step-header">
                <span class="step-icon">üìã</span>
                <span class="step-title">Case Final Status</span>
                <span class="step-status completed">‚úì Completed</span>
              </div>
              <div class="step-content">
                <p><strong>Final case status and closure details...</strong></p>
                
                {% set can_process = result.summary.can_process if result.summary and result.summary.can_process else False %}
                {% set verifier_decision = result.verification.verifier_summary.decision if result.verification and result.verification.verifier_summary and result.verification.verifier_summary.decision else '' %}
                
                <!-- Final Decision Display -->
                <div class="case-data-section" style="width: 100%; background: #f8f9fa; border: 2px solid #dee2e6; border-radius: 8px; padding: 20px; margin-bottom: 20px;">
                  <h4 style="color: #000000; font-weight: bold; margin-bottom: 15px;">üéØ FINAL DECISION</h4>
                  <div style="font-size: 1.2rem; font-weight: bold; padding: 15px; border-radius: 6px; text-align: center; margin-bottom: 15px;
                    {% if can_process %}
                      background: #d4edda; color: #155724; border: 2px solid #c3e6cb;
                    {% else %}
                      background: #f8d7da; color: #721c24; border: 2px solid #f5c6cb;
                    {% endif %}">
                    {% if can_process %}
                      ‚úÖ APPROVE AND PROCESS REFUND
                    {% else %}
                      üë§ PASS FOR HUMAN INTERVENTION
                    {% endif %}
                  </div>
                </div>

                <div class="case-data-section" style="width: 100%;">
                  <h4>üìã Final Case Status:</h4>
                  <div class="case-data-grid" style="width: 100%;">
                    <div class="data-row">
                      <span class="data-label">Refund Status:</span>
                      <span class="data-value">
                        {% if can_process %}
                          Approved
                        {% else %}
                          Pending Manual Review
                        {% endif %}
                      </span>
                    </div>
                    <div class="data-row">
                      <span class="data-label">Reason:</span>
                      <span class="data-value">{{ result.verification.verifier_summary.decision_reason if result.verification and result.verification.verifier_summary and result.verification.verifier_summary.decision_reason else 'All verification checks completed' }}</span>
                    </div>
                    <div class="data-row">
                      <span class="data-label">Description of Reason:</span>
                      <span class="data-value">{{ result.refund_processing.refund_decision.reason if result.refund_processing and result.refund_processing.refund_decision and result.refund_processing.refund_decision.reason else 'Case processing completed successfully' }}</span>
                    </div>
                    <div class="data-row">
                      <span class="data-label">Case Status:</span>
                      <span class="data-value">
                        {% if can_process %}
                          Closed - Refund Processed
                        {% else %}
                          Open - Manual Review Required
                        {% endif %}
                      </span>
                    </div>
                  </div>
                </div>
                
                <div class="agent-output" style="width: 100%;">
                  <h4>üì§ Case Closure Summary:</h4>
                  <div class="output-content" style="width: 100%;">
                <p><strong>Case Closure Status:</strong> 
                  {% if can_process %}
                    ‚úÖ Case successfully closed - Refund approved and processed
                  {% else %}
                    üë§ Case requires manual review - Human intervention needed
                  {% endif %}
                </p>
                <p><strong>Next Actions:</strong> 
                  {% if can_process %}
                    Refund will be processed automatically
                  {% else %}
                    Case will be assigned to human reviewer for manual processing
                  {% endif %}
                </p>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Investigation Report Content -->
        <div id="investigationReportContent" style="display: none; margin: 20px -40px 0 -40px; width: calc(100% + 80px);">
          <div class="agent-flow-section" style="width: calc(100% - 40px) !important; margin: 0 20px; padding: 50px 40px 56px 40px; background: #ffffff; box-sizing: border-box;">
            <h3 style="margin-top: 10px; padding-top: 0; margin-bottom: 20px;">üìä Investigation Report</h3>
            
        <!-- Tabbed Navigation -->
            <div class="tabs" id="reportTabs" style="display: none;">
          <button class="tab-btn active" data-tab="tab-workflow">
            Investigation Details
          </button>
          <button class="tab-btn" data-tab="tab-flow">
            Detailed Process Overview
          </button>
          <button class="tab-btn" data-tab="tab-graph">
            Interactive Agent Graph
          </button>
          <button class="tab-btn" data-tab="tab-comm">Communication</button>
          <button class="tab-btn" data-tab="tab-accounts">Account Operations</button>
        </div>

        <!-- Tabs: Panels -->
        <div id="tab-workflow" class="tab-panel active">
          <!-- Compact workflow summary -->
          {% set elig = result.investigation.eligibility or {} %} {% set ver =
          (result.verifier_summary or (result.verification.verifier_summary if result.verification else {})) %} {% set checks = ver.checks or {} %}
          {% set rd = result.summary or {} %} {% set er =
          result.enhanced_refund_decision or {} %}
        <div class="summary-grid">
          <div class="summary-card">
              <h3>Workflow Verdict</h3>
            {% set can_process_verdict = result.summary.can_process if result.summary and result.summary.can_process else False %}
            <div class="info-row">
                <span class="info-label">Refund</span
                ><span class="info-value"
                  ><span
                    class="status-badge {{ 'status-success' if can_process_verdict else 'status-danger' }}"
                    >{{ 'Processed' if can_process_verdict else 'Manual Review Required' }}</span
                  ></span
                >
            </div>
            <div class="info-row">
                <span class="info-label">Enhanced</span
                ><span class="info-value"
                  ><span
                    class="status-badge {{ 'status-success' if can_process_verdict else 'status-danger' }}"
                    >{{ 'Processed' if can_process_verdict else 'Manual Review Required' }}</span
                  ></span
                >
            </div>
            <div class="info-row">
                <span class="info-label">Final Verdict</span
                ><span class="info-value"
                  >{{ 'Refund Processed' if can_process_verdict else 'Manual Review Required' }}</span
              >
            </div>
            </div>
            <div class="summary-card">
              <h3>Key Checks</h3>
            <div class="info-row">
                <span class="info-label">Sanctions</span
                ><span class="info-value"
                  ><span
                    class="status-badge {{ 'status-success' if elig.sanctions_ok else 'status-danger' }}"
                    >{{ 'Passed' if elig.sanctions_ok else 'Failed' }}</span
                  ></span
              >
            </div>
              <div class="info-row">
                <span class="info-label">CSV Validation</span
                ><span class="info-value"
                  ><span
                    class="status-badge {{ 'status-success' if checks.csv_validation_ok else 'status-danger' }}"
                    >{{ 'Passed' if checks.csv_validation_ok else 'Failed'
                    }}</span
                  ></span
                >
          </div>
              <div class="info-row">
                <span class="info-label">Cross-Message</span
                ><span class="info-value"
                  ><span
                    class="status-badge {{ 'status-success' if checks.cross_checks_ok else 'status-danger' }}"
                    >{{ 'Passed' if checks.cross_checks_ok else 'Failed'
                    }}</span
                  ></span
                >
              </div>
              <div class="info-row">
                <span class="info-label">FX ‚â§ 300</span
                ><span class="info-value"
                  ><span
                    class="status-badge {{ 'status-success' if elig.fx_loss_within_limit else 'status-danger' }}"
                    >{{ 'Yes' if elig.fx_loss_within_limit else 'No' }}</span
                  ></span
                >
              </div>
            </div>
          <div class="summary-card">
              <h3>Reason & Context</h3>
              {% set reason_code = elig.reason or (result.parsed_data.pacs004.rsn if result.parsed_data.pacs004 else '') %}
              {% set p4_info = result.parsed_data.pacs004.rsn_info if result.parsed_data.pacs004 else '' %}
              {% set erd = er.processing_details if er and er.processing_details else None %}
              {% set pr = erd.payment_result if erd and erd.payment_result else None %}
              {% set cr = erd.closure_result if erd and erd.closure_result else None %}
              {% set car = erd.case_result if erd and erd.case_result else None %}
              {% set derived = (cr.reason if cr and cr.reason else (pr.reason if pr and pr.reason else (car.reason if car and car.reason else (rd.reason if rd and rd.reason else '')))) %}
              {% set desc = p4_info if p4_info else (derived if derived else 'N/A') %}
            <div class="info-row">
                <span class="info-label">Reason</span>
                <span class="info-value">{{ reason_code or 'N/A' }}</span>
            </div>
            <div class="info-row">
              <span class="info-label">Description</span>
                <span class="info-value">{{ desc }}</span>
              </div>
              <div class="info-row">
                <span class="info-label">MT103</span
                ><span class="info-value"
                  ><span class="status-badge status-info"
                    >{{ (elig.mt103_status.status if elig.mt103_status else
                    'N/A') }}</span
                  ></span
              >
            </div>
            </div>
          </div>

          <!-- Transaction Summary -->
          <div class="section" style="margin-top: 16px">
            <h3>Transaction Summary</h3>
            <div class="summary-card" style="border-left-color: #ffd700">
            <div class="info-row">
                <span class="info-label">UETR</span
                ><span class="info-value"
                  >{{ result.parsed_data.pacs004.uetr if result.parsed_data.pacs004 else
                  'N/A' }}</span
                >
              </div>
              <div class="info-row">
                <span class="info-label">End-to-End ID</span
                ><span class="info-value"
                  >{{ result.parsed_data.pacs004.e2e if result.parsed_data.pacs004 else
                  'N/A' }}</span
                >
              </div>
              <div class="info-row">
                <span class="info-label">Customer IBAN</span
                ><span class="info-value"
                  >{{ (result.parsed_data.pacs004.dbtr_iban if result.parsed_data and result.parsed_data.pacs004 and result.parsed_data.pacs004.dbtr_iban else (result.parsed_data.pacs008.dbtr_iban if result.parsed_data and result.parsed_data.pacs008 else 'N/A')) }}</span
                >
              </div>
              <div class="info-row">
                <span class="info-label">Return Amount</span
                ><span class="info-value"
                  >{{ result.parsed_data.pacs004.rtr_ccy if result.parsed_data.pacs004
                  else 'N/A' }} {{ result.parsed_data.pacs004.rtr_amount if
                  result.parsed_data.pacs004 else 'N/A' }}</span
                >
              </div>
              <div class="info-row">
                <span class="info-label">MT103 Status</span
                ><span class="info-value"
                  ><span class="status-badge status-info"
                    >{{ elig.mt103_status.status if elig and elig.mt103_status
                    else 'N/A' }}</span
                  ></span
                >
              </div>
              <div class="info-row">
                <span class="info-label">FX Loss (AUD)</span
                ><span class="info-value"
                  >{{ '%.2f' % (elig.fx_loss_aud or 0) if elig else '0.00'
                }}</span
              >
            </div>
            <div class="info-row">
                <span class="info-label">Channel Type</span
                ><span class="info-value"
                  ><span
                    class="status-badge {{ 'status-info' if elig.non_branch else 'status-warning' }}"
                    >{{ 'Non-branch' if elig.non_branch else 'Branch' }}</span
                  ></span
                >
              </div>
              <div class="info-row">
                <span class="info-label">Sanctions Check</span
                ><span class="info-value"
                  ><span
                    class="status-badge {{ 'status-success' if elig.sanctions_ok else 'status-danger' }}"
                    >{{ 'Passed' if elig.sanctions_ok else 'Failed' }}</span
                  ></span
                >
              </div>
              <div class="info-row">
                <span class="info-label">Auto-Refund Eligibility</span
                ><span class="info-value"
                  ><span
                    class="status-badge {{ 'status-success' if elig.eligible_auto_refund else 'status-danger' }}"
                    >{{ 'Yes' if elig.eligible_auto_refund else 'No' }}</span
                  ></span
                >
              </div>
              <div class="info-row">
                <span class="info-label">Refund Decision</span
                ><span class="info-value"
                  >{{ '‚è≥ Refund Pending' if not (rd and rd.can_process) else
                  '‚úÖ Refund Processed' }}</span
                >
              </div>
              <div class="info-row">
                <span class="info-label">Notification</span
                ><span class="info-value"
                  >{{
                  (er.processing_details.closure_result.closure.customer_notification
                  if er and er.processing_details and
                  er.processing_details.closure_result and
                  er.processing_details.closure_result.closure) or 'N/A'
                  }}</span
                >
              </div>
              <div class="info-row">
                <span class="info-label">Final Status</span
                ><span class="info-value"
                  >{{ (result.manual_review_case.status if result.manual_review_case else (er.processing_details.closure_result.closure.case_status
                  if er and er.processing_details and
                  er.processing_details.closure_result and
                  er.processing_details.closure_result.closure) or ('Processed'
                  if rd and rd.can_process else 'Pending')) }}</span
                >
              </div>
              {% if result.manual_review_case and result.manual_review_case.case_type == 'FX_LOSS_NO_FCA' %}
              <div class="info-row">
                <span class="info-label">Pending Until</span
                ><span class="info-value"
                  >{{ result.manual_review_case.pending_until or 'N/A' }}</span
                >
              </div>
              <div class="info-row">
                <span class="info-label">Case Type</span
                ><span class="info-value"
                  >FX Loss - No FCA Account</span
                >
              </div>
              {% endif %}
            </div>
          </div>

          <!-- Return Analysis -->
          <div class="section" style="margin-top: 16px">
            <h3>Return Analysis</h3>
            <div class="summary-card" style="border-left-color: #ffd700">
            <div class="info-row">
                <span class="info-label">Reason Code</span
                ><span class="info-value"
                  >{{ result.parsed_data.pacs004.rsn if result.parsed_data.pacs004 else
                  'N/A' }}</span
              >
            </div>
            <div class="info-row">
                <span class="info-label">Description</span
                ><span class="info-value"
                  >{{ result.parsed_data.pacs004.rsn_info if result.parsed_data.pacs004
                  else 'N/A' }}</span
                >
              </div>
              <div class="info-row">
                <span class="info-label">Action Required</span
                ><span class="info-value"
                  >{{ (elig.reason_analysis.action if elig and
                  elig.reason_analysis else 'N/A') |
                  replace('alternate_account','Alternate Account') }}</span
                >
              </div>
              <div class="info-row">
                <span class="info-label">Refund Note</span
                ><span class="info-value"
                  >{{ rd.reason if rd and (not rd.can_process) and rd.reason
                  else ('Complete 8-step enhanced refund flow executed' if er
                  else 'N/A') }}</span
                >
              </div>
            </div>
          </div>

          <!-- Processing Outcomes -->
          <div class="section" style="margin-top: 16px">
            <h3>Processing Outcomes</h3>
            <div class="outcomes-grid">
              {# Prefer verification summary (available in all runs), fallback to enhanced details #}
              {% set nr = ( (ver.nostro_result if ver and ver.nostro_result else None) 
                            or (er.processing_details.nostro_result if er and er.processing_details else None) ) %}
              {% set fd = (er.processing_details.fca_decision if er and er.processing_details else None) %}
              {% set pr = (er.processing_details.payment_result if er and er.processing_details else None) %}
              {% set cr = (er.processing_details.case_result if er and er.processing_details else None) %}
              {% set cl = (er.processing_details.closure_result if er and er.processing_details else None) %}

              <div class="verification-item">
                <div><span>üåç</span> <strong>Foreign Currency</strong></div>
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                  <span class="chip {{ 'chip-pass' if (elig and (not elig.is_aud_refund)) else 'chip-info' }}">{{ 'Detected' if (elig and (not elig.is_aud_refund)) else 'Domestic/NA' }}</span>
                </div>
              </div>

              <div class="verification-item">
                <div><span>‚úÖ</span> <strong>Nostro Verification</strong></div>
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                  {% if nr and (nr.found if nr else False) %}
                    <span class="chip chip-pass">Found</span>
                    {# Try to display Nostro account number from nostro_result first #}
                    {% set acct = None %}
                    {% if nr.nostro_entry is mapping %}
                      {% set acct = nr.nostro_entry.get('Account Number') or nr.nostro_entry.get('account_number') %}
                    {% endif %}
                    {# If not present, fallback to first debit Nostro op in account operations #}
                    {% if not acct %}
                      {% set ops = (result.refund_processing.refund_decision.account_operations if result.refund_processing and result.refund_processing.refund_decision and result.refund_processing.refund_decision.account_operations else (result.refund_decision.account_operations if result.refund_decision and result.refund_decision.account_operations else (result.enhanced_refund_decision.account_operations if result.enhanced_refund_decision and result.enhanced_refund_decision.account_operations else []))) %}
                      {% for op in ops %}
                        {% if (not acct) and (op.operation_type|lower) == 'debit' and ('nostro' in (op.account_name|lower)) %}
                          {% set acct = op.account_number %}
                        {% endif %}
                      {% endfor %}
                    {% endif %}
                    {% if acct %}
                      <span class="chip chip-info">{{ acct }}</span>
                    {% endif %}
                  {% elif nr %}
                    <span class="chip chip-fail">Not Found</span>
                  {% else %}
                    <span class="chip chip-info">N/A</span>
                  {% endif %}
                </div>
              </div>

              <div class="verification-item">
                <div><span>‚ÑπÔ∏è</span> <strong>FCA Processing</strong></div>
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                  <span class="chip {{ 'chip-pass' if (fd and fd.is_fca_refund) else 'chip-info' }}">{{ 'FCA Refund' if (fd and fd.is_fca_refund) else 'Standard Refund' }}</span>
                </div>
              </div>

              <div class="verification-item">
                <div><span>‚úÖ</span> <strong>Payment</strong></div>
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                  {% if rd and rd.can_process %}
                    <span class="chip chip-pass">Processed</span>
                    {% if result.transaction_id %}
                      <span class="chip chip-info">{{ result.transaction_id }}</span>
                    {% endif %}
                  {% elif pr %}
                    <span class="chip {{ 'chip-pass' if pr.success else 'chip-fail' }}">{{ 'Processed' if pr.success else 'Failed' }}</span>
                  {% else %}
                    <span class="chip chip-info">N/A</span>
                  {% endif %}
                </div>
              </div>

              <div class="verification-item">
                <div><span>‚úÖ</span> <strong>Case Management</strong></div>
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                  {% if cr and cr.success and cr.qf_case %}
                    <span class="chip chip-pass">Created</span>
                    <span class="chip chip-info">{{ cr.qf_case.case_id }}</span>
                  {% elif cr %}
                    <span class="chip chip-fail">Failed</span>
                  {% else %}
                    <span class="chip chip-info">N/A</span>
                  {% endif %}
                </div>
              </div>

              <div class="verification-item">
                <div><span>‚úÖ</span> <strong>Case Closure</strong></div>
                <div style="display:flex;gap:8px;flex-wrap:wrap">
                  {% if cl and cl.success and cl.closure %}
                    <span class="chip chip-pass">Closed</span>
                    <span class="chip chip-info">{{ cl.closure.case_status }}</span>
                  {% elif cl %}
                    <span class="chip chip-fail">Failed</span>
                  {% else %}
                    <span class="chip chip-info">N/A</span>
                  {% endif %}
                </div>
              </div>

            </div>
          </div>

          <!-- Eligibility Checklist (expanded) -->
          <div class="section" style="margin-top: 16px">
            <h3>Eligibility Checklist</h3>
            <div class="eligibility-grid">
              <div
                class="eligibility-item {{ 'pass' if not (elig.is_aud_refund) else 'fail' }}"
              >
                <h4>AUD Refund</h4>
                <span class="status-badge {{ 'status-success' if not (elig.is_aud_refund) else 'status-danger' }}">{{ 'Not AUD' if not (elig.is_aud_refund) else 'AUD' }}</span>
              </div>
              <div
                class="eligibility-item {{ 'pass' if elig.fx_loss_within_limit else 'fail' }}"
              >
                <h4>FX Loss Limit</h4>
                <span class="status-badge {{ 'status-success' if elig.fx_loss_within_limit else 'status-danger' }}">{{ 'Within' if elig.fx_loss_within_limit else 'Exceeds' }}</span>
              </div>
              <div
                class="eligibility-item {{ 'pass' if elig.non_branch else 'fail' }}"
              >
                <h4>Channel Type</h4>
                <span class="status-badge {{ 'status-info' if elig.non_branch else 'status-warning' }}">{{ 'Non-branch' if elig.non_branch else 'Branch' }}</span>
              </div>
              <div
                class="eligibility-item {{ 'pass' if elig.sanctions_ok else 'fail' }}"
              >
                <h4>Sanctions</h4>
                <span class="status-badge {{ 'status-success' if elig.sanctions_ok else 'status-danger' }}">{{ 'Passed' if elig.sanctions_ok else 'Failed' }}</span>
              </div>
              <div
                class="eligibility-item {{ 'pass' if checks.sequence_ok else 'fail' }}"
              >
                <h4>Sequence Check</h4>
                <span class="status-badge {{ 'status-success' if checks.sequence_ok else 'status-danger' }}">{{ 'Passed' if checks.sequence_ok else 'Failed' }}</span>
              </div>
              <div
                class="eligibility-item {{ 'pass' if checks.cross_checks_ok else 'fail' }}"
              >
                <h4>Cross-Message Validation</h4>
                <span class="status-badge {{ 'status-success' if checks.cross_checks_ok else 'status-danger' }}">{{ 'Passed' if checks.cross_checks_ok else 'Failed' }}</span>
              </div>
              <div
                class="eligibility-item {{ 'pass' if checks.csv_validation_ok else 'fail' }}"
              >
                <h4>Customer Validation</h4>
                <span class="status-badge {{ 'status-success' if checks.csv_validation_ok else 'status-danger' }}">{{ 'Passed' if checks.csv_validation_ok else 'Failed' }}</span>
              </div>
            </div>
          </div>

          <!-- FX Details -->
          <div class="section" style="margin-top: 16px">
            <h3>FX Details</h3>
            <div class="summary-card" style="border-left-color: #ffd700">
            <div class="info-row">
                <span class="info-label">Currency Received</span
                ><span class="info-value"
                  >{{ elig.returned_currency if elig else '-' }}</span
                >
              </div>
              <div class="info-row">
                <span class="info-label">Original Amount</span
                ><span class="info-value"
                  >{{ elig.original_currency if elig else 'N/A' }} {{ '%.2f' %
                  (elig.original_amount or 0) if elig else '0.00' }}</span
                >
              </div>
              <div class="info-row">
                <span class="info-label">Returned Amount</span
                ><span class="info-value"
                  >{{ elig.returned_currency if elig else 'N/A' }} {{ '%.2f' %
                  (elig.returned_amount or 0) if elig else '0.00' }}</span
                >
              </div>
              <div class="info-row">
                <span class="info-label">Original Amount (AUD)</span
                ><span class="info-value"
                  >{{ 'AUD ' + ('%.2f' % elig.original_amount_aud) if elig and
                  elig.original_amount_aud is not none else 'N/A' }}</span
                >
              </div>
              <div class="info-row">
                <span class="info-label">Returned Amount (AUD)</span
                ><span class="info-value"
                  >{{ 'AUD ' + ('%.2f' % elig.returned_amount_aud) if elig and
                  elig.returned_amount_aud is not none else 'N/A' }}</span
                >
              </div>
              <div class="info-row">
                <span class="info-label"
                  >FX Rate ({{ elig.original_currency if elig else '-' }} ‚Üí
                  AUD)</span
                ><span class="info-value"
                  >{{ ('%.6f' % elig.original_aud_rate) if elig and
                  elig.original_aud_rate is not none else 'N/A' }}</span
                >
              </div>
              <div class="info-row">
                <span class="info-label">FX Loss</span
                ><span class="info-value"
                  >AUD {{ '%.2f' % (elig.fx_loss_aud or 0) if elig else '0.00'
                  }}</span
                >
              </div>
              {% if result.fx %}
              <div class="info-row">
                <span class="info-label">FCA Account Check</span
                ><span class="info-value"
                  >{{ 'Found' if result.fx.fca_account_found else 'Not Found' }}</span
                >
              </div>
              {% endif %}
            </div>
          </div>
        </div>
        
        <!-- Account Operations Tab -->
        <div id="tab-accounts" class="tab-panel">
          <div class="section" style="margin-top: 0">
            <h3>üí∞ Detailed Account Operations</h3>
            {% set account_ops = (result.refund_processing.refund_decision.account_operations if result.refund_processing and result.refund_processing.refund_decision and result.refund_processing.refund_decision.account_operations else (result.refund_decision.account_operations if result.refund_decision and result.refund_decision.account_operations else (result.enhanced_refund_decision.account_operations if result.enhanced_refund_decision and result.enhanced_refund_decision.account_operations else []))) %}
            {% if account_ops %}
              <!-- Balance Comparison Table -->
              <div class="balance-comparison-table" style="margin-bottom: 30px;">
                <h4 style="margin-bottom: 15px; color: #495057;">Balance Changes Summary</h4>
                <table style="width: 100%; border-collapse: collapse; background: #fefef8; border-radius: 8px; overflow: hidden; box-shadow: 0 2px 4px rgba(0,0,0,0.1);">
                  <thead>
                    <tr style="background: #f8f9fa;">
                      <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600;">Account</th>
                      <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600;">Type</th>
                      <th style="padding: 12px; text-align: left; border-bottom: 2px solid #dee2e6; font-weight: 600;">Currency</th>
                      <th style="padding: 12px; text-align: right; border-bottom: 2px solid #dee2e6; font-weight: 600;">Balance Before</th>
                      <th style="padding: 12px; text-align: center; border-bottom: 2px solid #dee2e6; font-weight: 600;">Operation</th>
                      <th style="padding: 12px; text-align: right; border-bottom: 2px solid #dee2e6; font-weight: 600;">Amount</th>
                      <th style="padding: 12px; text-align: right; border-bottom: 2px solid #dee2e6; font-weight: 600;">Balance After</th>
                      <th style="padding: 12px; text-align: right; border-bottom: 2px solid #dee2e6; font-weight: 600;">Net Change</th>
                    </tr>
                  </thead>
                  <tbody>
                    {% for op in account_ops %}
                    <tr style="border-bottom: 1px solid #dee2e6;">
                      <td style="padding: 12px;">
                        <strong>{{ op.account_name }}</strong><br>
                        <small style="color: #6c757d;">{{ op.account_number }}</small>
                      </td>
                      <td style="padding: 12px;">
                        {% if 'Nostro' in op.account_name %}
                          <span style="background: #fff8dc; color: #b8860b; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Nostro</span>
                        {% elif 'FCA' in op.account_name %}
                          <span style="background: #f3e5f5; color: #7b1fa2; padding: 4px 8px; border-radius: 4px; font-size: 12px;">FCA</span>
                        {% elif 'Customer' in op.account_name %}
                          <span style="background: #e8f5e8; color: #2e7d32; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Customer</span>
                        {% else %}
                          <span style="background: #fff3e0; color: #f57c00; padding: 4px 8px; border-radius: 4px; font-size: 12px;">Other</span>
                        {% endif %}
                      </td>
                      <td style="padding: 12px;">{{ op.currency }}</td>
                      <td style="padding: 12px; text-align: right; font-family: monospace;">{{ op.balance_before }}</td>
                      <td style="padding: 12px; text-align: center;">
                        <span class="badge {{ 'debit' if (op.operation_type|lower) == 'debit' else 'credit' }}" 
                              style="background: {{ '#dc3545' if (op.operation_type|lower) == 'debit' else '#28a745' }}; color: white; padding: 6px 10px; border-radius: 4px; font-size: 12px; font-weight: bold; letter-spacing: 0.2px;">
                          {{ op.operation_type.upper() }}
                        </span>
                      </td>
                      <td style="padding: 12px; text-align: right; font-family: monospace; font-weight: bold;">
                        {{ op.amount }} {{ op.currency }}
                      </td>
                      <td style="padding: 12px; text-align: right; font-family: monospace;">{{ op.balance_after }}</td>
                      <td style="padding: 12px; text-align: right; font-family: monospace; font-weight: bold; color: {{ '#dc3545' if (op.operation_type|lower) == 'debit' else '#28a745' }};">
                        {% set before_amount = op.balance_before.replace(op.currency, '').replace(',', '').strip() %}
                        {% set after_amount = op.balance_after.replace(op.currency, '').replace(',', '').strip() %}
                        {% set change = after_amount | float - before_amount | float %}
                        {{ op.currency }} {{ "%.2f" | format(change) }}
                      </td>
                    </tr>
                    {% endfor %}
                  </tbody>
                </table>
              </div>
              
              
              
              <!-- Detailed Operations Cards -->
              <h4 style="margin: 10px 0 15px 0; color: #495057;">Detailed Operations</h4>
              <div class="account-operations-grid">
                {% for op in account_ops %}
                  <div class="operation-card {{ 'debit' if (op.operation_type|lower) == 'debit' else 'credit' }}">
                    <div class="operation-header">
                      <span class="operation-type">{{ op.operation_type.upper() }}</span>
                      <span class="operation-amount">{{ op.amount }} {{ op.currency }}</span>
                    </div>
                    <div class="operation-details">
                      <div class="account-info">
                        <strong>{{ op.account_name }}</strong>
                        <br>
                        <small>{{ op.account_number }}</small>
                      </div>
                      <div class="balance-info">
                        <div class="balance-row">
                          <span class="balance-label">Before:</span>
                          <span class="balance-value">{{ op.balance_before }}</span>
                        </div>
                        <div class="balance-row">
                          <span class="balance-label">After:</span>
                          <span class="balance-value">{{ op.balance_after }}</span>
                        </div>
                      </div>
                      <div class="operation-reference">
                        <small>Reference: {{ op.reference }}</small>
                        <br>
                        <small>{{ op.description }}</small>
                      </div>
                    </div>
                  </div>
                {% endfor %}
              </div>
            {% else %}
              <div class="no-operations">
                <p>No account operations recorded for this transaction.</p>
              </div>
            {% endif %}
          </div>
        </div>
        
        <div id="tab-flow" class="tab-panel">
          <div class="section" style="margin-top: 0">
            <h3>Comprehensive Process Overview</h3>
            
            <!-- Visual Decision Flow Section -->
            <div class="flow-section" style="margin-bottom: 40px;">
              <h4>üìä Visual Decision Flow</h4>
              
              <!-- Pre-Flow Checklist (flow_.md) -->
              <div style="margin-bottom: 30px;">
                <h5>Pre-Flow Checklist (flow_.md)</h5>
              <div class="flowchart-container" style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef;">
                  {% set checklist_results = (result.flow_checklist.checks if result.flow_checklist and result.flow_checklist.checks else {}) %}
                  {% set checklist_path = (result.flow_checklist.decision_path if result.flow_checklist and result.flow_checklist.decision_path else []) %}
                  {% set manual_review = (result.flow_checklist.manual_review_required if result.flow_checklist else false) %}
                
                <div class="flow-nodes" style="display: flex; flex-wrap: wrap; gap: 15px; align-items: center;">
                  <!-- Start Node -->
                  <div class="flow-node start" style="background: #28a745; color: white; padding: 10px 15px; border-radius: 6px; font-weight: bold;">
                    Start
                  </div>
                  
                  <!-- Flow Arrow -->
                  <div class="flow-arrow" style="color: #6c757d; font-size: 18px;">‚Üí</div>
                  
                  <!-- Email Rejection Check -->
                  <div class="flow-node {{ 'terminal' if checklist_results.payments_team_rejection_email else 'passed' }}" 
                       style="background: {{ '#dc3545' if checklist_results.payments_team_rejection_email else '#28a745' }}; color: white; padding: 8px 12px; border-radius: 6px; font-size: 12px;">
                    Email Rejection
                  </div>
                  
                  <div class="flow-arrow" style="color: #6c757d; font-size: 18px;">‚Üí</div>
                  
                  <!-- Correct Payment Check -->
                  <div class="flow-node {{ 'terminal' if not checklist_results.correct_payment_attached else 'passed' }}" 
                       style="background: {{ '#dc3545' if not checklist_results.correct_payment_attached else '#28a745' }}; color: white; padding: 8px 12px; border-radius: 6px; font-size: 12px;">
                    Correct Payment
                  </div>
                  
                  <div class="flow-arrow" style="color: #6c757d; font-size: 18px;">‚Üí</div>
                  
                  <!-- MT103/202 Check -->
                  <div class="flow-node {{ 'terminal' if checklist_results.has_mt103_and_202 else 'passed' }}" 
                       style="background: {{ '#dc3545' if checklist_results.has_mt103_and_202 else '#28a745' }}; color: white; padding: 8px 12px; border-radius: 6px; font-size: 12px;">
                    MT103/202
                  </div>
                  
                  <div class="flow-arrow" style="color: #6c757d; font-size: 18px;">‚Üí</div>
                  
                  <!-- AUD Payment Check -->
                  <div class="flow-node {{ 'terminal' if checklist_results.is_aud_payment else 'passed' }}" 
                       style="background: {{ '#dc3545' if checklist_results.is_aud_payment else '#28a745' }}; color: white; padding: 8px 12px; border-radius: 6px; font-size: 12px;">
                      {{ 'AUD Payment' if checklist_results.is_aud_payment else 'Not AUD Payment' }}
                  </div>
                  
                  <div class="flow-arrow" style="color: #6c757d; font-size: 18px;">‚Üí</div>
                  
                  <!-- FX Loss Check -->
                    <div class="flow-node {{ 'terminal' if result.fx_calculation and result.fx_calculation.exceeds_limit else 'passed' }}" 
                         style="background: {{ '#dc3545' if (result.fx_calculation and result.fx_calculation.exceeds_limit) else '#28a745' }}; color: white; padding: 8px 12px; border-radius: 6px; font-size: 12px;">
                    FX ‚â§ $300
                  </div>
                  
                  <div class="flow-arrow" style="color: #6c757d; font-size: 18px;">‚Üí</div>
                  
                  <!-- End Decision -->
                  {% if manual_review %}
                  <div class="flow-node terminal" style="background: #dc3545; color: white; padding: 10px 15px; border-radius: 6px; font-weight: bold;">
                    Manual Review
                  </div>
                  {% else %}
                  <div class="flow-node proceed" style="background: #ffd700; color: black; padding: 10px 15px; border-radius: 6px; font-weight: bold;">
                    Proceed to Refund
                  </div>
                  {% endif %}
                </div>
                
                  
              </div>
            </div>
            
            <!-- Refund Decision Tree (refund_flow_.md) -->
              <div style="margin-bottom: 30px;">
                <h5>Refund Decision Tree (D1-D9)</h5>
              <div class="flowchart-container" style="background: #f8f9fa; padding: 20px; border-radius: 8px; border: 1px solid #e9ecef;">
                  {% set refund_path = result.summary.decision_path if result.summary and result.summary.decision_path else [] %}
                  {% set can_process = result.summary.can_process if result.summary and result.summary.can_process is not none else false %}
                  {% set refund_text = (refund_path | join(' | ')) %}
                  {% set d1_d9_decisions = result.summary.d1_d9_decisions if result.summary and result.summary.d1_d9_decisions else {} %}
                  
                  
                  
                  
                  
                
                <div class="refund-tree" style="display: flex; flex-direction: column; gap: 20px;">
                  <!-- D1: Foreign Currency -->
                  <div class="decision-level" style="display: flex; align-items: center; gap: 15px;">
                    <div class="decision-node" style="background: #ffd700; color: black; padding: 8px 12px; border-radius: 6px; font-size: 12px; font-weight: bold;">
                      D1: FCY?
                    </div>
                      {% set d1_decision = d1_d9_decisions.D1.decision if d1_d9_decisions and d1_d9_decisions.D1 else 'No' %}
                      {% set d1_statement = d1_d9_decisions.D1.statement if d1_d9_decisions and d1_d9_decisions.D1 else 'Not processed' %}
                      <div class="decision-result" style="display: flex; gap: 10px; align-items: center;">
                        <span class="chip {{ 'chip-pass' if d1_decision == 'Yes' else 'chip-fail' if d1_decision == 'No' else 'chip-info' }}">{{ d1_decision }}</span>
                        <span class="chip chip-info">{{ d1_statement }}</span>
                    </div>
                  </div>
                  
                  <!-- D2: Nostro Found -->
                  <div class="decision-level" style="display: flex; align-items: center; gap: 15px;">
                    <div class="decision-node" style="background: #ffd700; color: black; padding: 8px 12px; border-radius: 6px; font-size: 12px; font-weight: bold;">
                      D2: Nostro?
                    </div>
                      {% set d2_decision = d1_d9_decisions.D2.decision if d1_d9_decisions and d1_d9_decisions.D2 else 'No' %}
                      {% set d2_statement = d1_d9_decisions.D2.statement if d1_d9_decisions and d1_d9_decisions.D2 else 'Not processed' %}
                      <div class="decision-result" style="display: flex; gap: 10px; align-items: center;">
                        <span class="chip {{ 'chip-pass' if d2_decision == 'Yes' else 'chip-fail' if d2_decision == 'No' else 'chip-info' }}">{{ d2_decision }}</span>
                        <span class="chip chip-info">{{ d2_statement }}</span>
                    </div>
                  </div>
                  
                  <!-- D3: FCA Refund -->
                  <div class="decision-level" style="display: flex; align-items: center; gap: 15px;">
                    <div class="decision-node" style="background: #ffd700; color: black; padding: 8px 12px; border-radius: 6px; font-size: 12px; font-weight: bold;">
                      D3: FCA?
                    </div>
                      {% set d3_decision = d1_d9_decisions.D3.decision if d1_d9_decisions and d1_d9_decisions.D3 else 'No' %}
                      {% set d3_statement = d1_d9_decisions.D3.statement if d1_d9_decisions and d1_d9_decisions.D3 else 'Not processed' %}
                      <div class="decision-result" style="display: flex; gap: 10px; align-items: center;">
                        <span class="chip {{ 'chip-pass' if d3_decision == 'Yes' else 'chip-fail' if d3_decision == 'No' else 'chip-info' }}">{{ d3_decision }}</span>
                        <span class="chip chip-info">{{ d3_statement }}</span>
                    </div>
                  </div>
                  
                    <!-- D4: MT103/202 -->
                  <div class="decision-level" style="display: flex; align-items: center; gap: 15px;">
                    <div class="decision-node" style="background: #ffd700; color: black; padding: 8px 12px; border-radius: 6px; font-size: 12px; font-weight: bold;">
                        D4: MT103/202?
                    </div>
                      {% set d4_decision = d1_d9_decisions.D4.decision if d1_d9_decisions and d1_d9_decisions.D4 else 'No' %}
                      {% set d4_statement = d1_d9_decisions.D4.statement if d1_d9_decisions and d1_d9_decisions.D4 else 'Not processed' %}
                      <div class="decision-result" style="display: flex; gap: 10px; align-items: center;">
                        <span class="chip {{ 'chip-pass' if d4_decision == 'Yes' else 'chip-fail' if d4_decision == 'No' else 'chip-info' }}">{{ d4_decision }}</span>
                        <span class="chip chip-info">{{ d4_statement }}</span>
                    </div>
                  </div>
                  
                    <!-- D5: Amendment Sent -->
                  <div class="decision-level" style="display: flex; align-items: center; gap: 15px;">
                      <div class="decision-node" style="background: #ffd700; color: black; padding: 8px 12px; border-radius: 6px; font-size: 12px; font-weight: bold;">
                        D5: Amendment?
                    </div>
                      {% set d5_decision = d1_d9_decisions.D5.decision if d1_d9_decisions and d1_d9_decisions.D5 else 'N/A' %}
                      {% set d5_statement = d1_d9_decisions.D5.statement if d1_d9_decisions and d1_d9_decisions.D5 else 'Not processed' %}
                      <div class="decision-result" style="display: flex; gap: 10px; align-items: center;">
                        <span class="chip {{ 'chip-pass' if d5_decision == 'Yes' else 'chip-fail' if d5_decision == 'No' else 'chip-info' }}">{{ d5_decision }}</span>
                        <span class="chip chip-info">{{ d5_statement }}</span>
                  </div>
                </div>
                
                    <!-- D6: No Funds Due Charges -->
                    <div class="decision-level" style="display: flex; align-items: center; gap: 15px;">
                      <div class="decision-node" style="background: #ffd700; color: black; padding: 8px 12px; border-radius: 6px; font-size: 12px; font-weight: bold;">
                        D6: No Charges?
                  </div>
                      {% set d6_decision = d1_d9_decisions.D6.decision if d1_d9_decisions and d1_d9_decisions.D6 else 'N/A' %}
                      {% set d6_statement = d1_d9_decisions.D6.statement if d1_d9_decisions and d1_d9_decisions.D6 else 'Not processed' %}
                      <div class="decision-result" style="display: flex; gap: 10px; align-items: center;">
                        <span class="chip {{ 'chip-pass' if d6_decision == 'Yes' else 'chip-fail' if d6_decision == 'No' else 'chip-info' }}">{{ d6_decision }}</span>
                        <span class="chip chip-info">{{ d6_statement }}</span>
                </div>
              </div>
                    
                    <!-- D7: Branch Payment -->
                    <div class="decision-level" style="display: flex; align-items: center; gap: 15px;">
                      <div class="decision-node" style="background: #ffd700; color: black; padding: 8px 12px; border-radius: 6px; font-size: 12px; font-weight: bold;">
                        D7: Branch?
            </div>
                      {% set d7_decision = d1_d9_decisions.D7.decision if d1_d9_decisions and d1_d9_decisions.D7 else 'N/A' %}
                      {% set d7_statement = d1_d9_decisions.D7.statement if d1_d9_decisions and d1_d9_decisions.D7 else 'Not processed' %}
                      <div class="decision-result" style="display: flex; gap: 10px; align-items: center;">
                        <span class="chip {{ 'chip-pass' if d7_decision == 'Yes' else 'chip-fail' if d7_decision == 'No' else 'chip-info' }}">{{ d7_decision }}</span>
                        <span class="chip chip-info">{{ d7_statement }}</span>
          </div>
        </div>
        
                    <!-- D8: Is Markets -->
                    <div class="decision-level" style="display: flex; align-items: center; gap: 15px;">
                      <div class="decision-node" style="background: #ffd700; color: black; padding: 8px 12px; border-radius: 6px; font-size: 12px; font-weight: bold;">
                        D8: Markets?
                    </div>
                      {% set d8_decision = d1_d9_decisions.D8.decision if d1_d9_decisions and d1_d9_decisions.D8 else 'No' %}
                      {% set d8_statement = d1_d9_decisions.D8.statement if d1_d9_decisions and d1_d9_decisions.D8 else 'Not processed' %}
                      <div class="decision-result" style="display: flex; gap: 10px; align-items: center;">
                        <span class="chip {{ 'chip-pass' if d8_decision == 'Yes' else 'chip-fail' if d8_decision == 'No' else 'chip-info' }}">{{ d8_decision }}</span>
                        <span class="chip chip-info">{{ d8_statement }}</span>
                    </div>
                    </div>
                    
                    <!-- D9: Client Has Valid Email -->
                    <div class="decision-level" style="display: flex; align-items: center; gap: 15px;">
                      <div class="decision-node" style="background: #ffd700; color: black; padding: 8px 12px; border-radius: 6px; font-size: 12px; font-weight: bold;">
                        D9: Email?
                  </div>
                      {% set d9_decision = d1_d9_decisions.D9.decision if d1_d9_decisions and d1_d9_decisions.D9 else 'No' %}
                      {% set d9_statement = d1_d9_decisions.D9.statement if d1_d9_decisions and d1_d9_decisions.D9 else 'Not processed' %}
                      <div class="decision-result" style="display: flex; gap: 10px; align-items: center;">
                        <span class="chip {{ 'chip-pass' if d9_decision == 'Yes' else 'chip-fail' if d9_decision == 'No' else 'chip-info' }}">{{ d9_decision }}</span>
                        <span class="chip chip-info">{{ d9_statement }}</span>
                </div>
                </div>
                    
                    <!-- Final Result -->
                    <div class="decision-level" style="display: flex; align-items: center; gap: 15px;">
                      <div class="decision-node {{ 'success' if can_process else 'failed' }}" 
                           style="background: {{ '#28a745' if can_process else '#dc3545' }}; color: white; padding: 10px 15px; border-radius: 6px; font-weight: bold;">
                        {{ 'Refund Processed' if can_process else 'Refund Failed' }}
                      </div>
                    </div>
                  </div>
            </div>
          </div>
        </div>
        
          
            
            <!-- Detailed Agent Results Section -->
            <div class="flow-section">
              <h4>üîç Detailed Agent Results</h4>
              {% set elig = (result.investigation.eligibility if result.investigation and result.investigation.eligibility else {}) %}
              {% set ver = (result.verification.verifier_summary if result.verification and result.verification.verifier_summary else {}) %}
              {% set checks = (ver.checks if ver and ver.checks else {}) %}
              {% set fx_data = (result.fx_calculation if result.fx_calculation else {}) %}
              {% set checklist_data = (result.flow_checklist.checks if result.flow_checklist and result.flow_checklist.checks else {}) %}
              {% set refund_data = (result.refund_decision if result.refund_decision else (result.summary if result.summary else {})) %}
              {% set comm_data = (result.communication_templates if result.communication_templates else {}) %}
              {% set nostro_data = (ver.nostro_result if ver and ver.nostro_result else {}) %}
              
            <div class="message-templates">
                <!-- Logger Agent (Prepared Email) -->
                {% set prep = (result.prep_logger.email_payload if result.prep_logger and result.prep_logger.email_payload else {}) %}
              <details class="template-item">
                <summary style="font-weight: 600">
                    üìù Logger Agent ‚Äî <span class="chip {{ 'chip-info' if prep else 'chip-warning' }}">{{ 'Prepared' if prep else 'No Email' }}</span>
                </summary>
                <div class="template-content">
                  <div class="kv-grid">
                      <div>Subject</div>
                      <div><span class="chip chip-info">{{ prep.subject or 'return of funds' }}</span></div>
                      <div>Reference</div>
                      <div><span class="chip chip-info">{{ prep.reference or 'N/A' }}</span></div>
                      <div>Recipient</div>
                      <div><span class="chip chip-info">{{ (prep.customer_name ~ ' <' ~ prep.customer_email ~ '>') if prep.customer_email else 'N/A' }}</span></div>
                    </div>
                    <div style="margin-top:12px">
                      <div style="font-weight:600;margin-bottom:6px;">Email Body</div>
                      {% if prep.body %}
                      <pre style="white-space:pre-wrap;background:#f8f9fa;border:1px solid #e9ecef;border-radius:6px;padding:12px;">{{ prep.body }}</pre>
                      {% else %}
                      <em>No prepared email body.</em>
                      {% endif %}
                  </div>
                </div>
              </details>
                <!-- Investigation Agent Details -->
              <details class="template-item">
                <summary style="font-weight: 600">
                    üîç Investigation Agent ‚Äî
                    <span class="chip {{ 'chip-pass' if (checks.csv_validation_ok and checks.cross_checks_ok) else 'chip-fail' }}">
                      {{ 'PASS' if (checks.csv_validation_ok and checks.cross_checks_ok) else 'FAIL' }}
                    </span>
                </summary>
                <div class="template-content">
                  <div class="kv-grid">
                      <div>UETR</div>
                      <div><span class="chip chip-info">{{ result.parsed_data.pacs004.uetr if result.parsed_data and result.parsed_data.pacs004 else '-' }}</span></div>
                      <div>E2E ID</div>
                      <div><span class="chip chip-info">{{ result.parsed_data.pacs004.e2e if result.parsed_data and result.parsed_data.pacs004 else '-' }}</span></div>
                      <div>IBAN</div>
                      <div><span class="chip chip-info">{{ result.parsed_data.pacs004.cdtr_iban if result.parsed_data and result.parsed_data.pacs004 else '-' }}</span></div>
                      <div>Return Reason</div>
                      <div><span class="chip chip-info">{{ elig.reason or 'N/A' }}</span></div>
                      <div>Reason Info</div>
                      <div><span class="chip chip-info">{{ elig.reason_info or 'N/A' }}</span></div>
                      <div>Auto Refund Eligible</div>
                      <div><span class="chip {{ 'chip-pass' if elig.eligible_auto_refund else 'chip-fail' }}">{{ 'Yes' if elig.eligible_auto_refund else 'No' }}</span></div>
                      <div>Customer Valid</div>
                      <div><span class="chip {{ 'chip-pass' if result.investigation.csv_validation.ok else 'chip-fail' }}">{{ 'Yes' if result.investigation.csv_validation.ok else 'No' }}</span></div>
                      <div>Cross Checks</div>
                      <div><span class="chip {{ 'chip-pass' if not result.investigation.cross_errors else 'chip-fail' }}">{{ 'OK' if not result.investigation.cross_errors else 'FAIL' }}</span></div>
                      <div>Currency Mismatch</div>
                      <div><span class="chip {{ 'chip-fail' if elig.currency_mismatch else 'chip-pass' }}">{{ 'Yes' if elig.currency_mismatch else 'No' }}</span></div>
                  </div>
                </div>
              </details>
                
                <!-- Actioning Agent (Combined) -->
              <details class="template-item">
                <summary style="font-weight: 600">
                    ‚öôÔ∏è Actioning Agent ‚Äî
                    <span class="chip {{ 'chip-pass' if (not fx_data.exceeds_limit) and (not result.manual_review_required) and (nostro_data.found) else 'chip-warning' }}">Overview</span>
                </summary>
                <div class="template-content">
                    <!-- Nested: FX -->
                    <details>
                      <summary style="font-weight: 600">üí± FX Calculation</summary>
                      <div class="kv-grid" style="margin-top:8px;">
                        <div>Original Amount</div>
                        <div><span class="chip chip-info">{{ fx_data.original_amount or 0 }} {{ fx_data.original_currency or '' }}</span></div>
                        <div>Returned Amount</div>
                        <div><span class="chip chip-info">{{ fx_data.returned_amount or 0 }} {{ fx_data.returned_currency or '' }}</span></div>
                        <div>Original AUD</div>
                        <div><span class="chip chip-info">${{ fx_data.original_amount_aud or 0 }}</span></div>
                        <div>Returned AUD</div>
                        <div><span class="chip chip-info">${{ fx_data.returned_amount_aud or 0 }}</span></div>
                        <div>FX Loss AUD</div>
                        <div><span class="chip {{ 'chip-fail' if fx_data.exceeds_limit else 'chip-pass' }}">${{ fx_data.loss_aud or 0 }}</span></div>
                        <div>Exceeds $300</div>
                        <div><span class="chip {{ 'chip-fail' if fx_data.exceeds_limit else 'chip-pass' }}">{{ 'Yes' if fx_data.exceeds_limit else 'No' }}</span></div>
                        <div>FCA Account Found</div>
                        <div><span class="chip {{ 'chip-pass' if fx_data.fca_account_found else 'chip-fail' }}">{{ 'Yes' if fx_data.fca_account_found else 'No' }}</span></div>
                        <div>Calculation Method</div>
                        <div><span class="chip chip-info">{{ fx_data.calculation_method or 'N/A' }}</span></div>
                    </div>
                    </details>

                    <!-- Nested: Checklist -->
                    <details>
                      <summary style="font-weight: 600">‚úÖ Checklist</summary>
                      <div class="kv-grid" style="margin-top:8px;">
                        <div>Email Rejection</div>
                        <div><span class="chip {{ 'chip-fail' if checklist_data.payments_team_rejection_email else 'chip-pass' }}">{{ 'Yes' if checklist_data.payments_team_rejection_email else 'No' }}</span></div>
                        <div>Correct Payment</div>
                        <div><span class="chip {{ 'chip-pass' if checklist_data.correct_payment_attached else 'chip-fail' }}">{{ 'Yes' if checklist_data.correct_payment_attached else 'No' }}</span></div>
                        <div>Has MT103/202</div>
                        <div><span class="chip {{ 'chip-fail' if checklist_data.has_mt103_and_202 else 'chip-pass' }}">{{ 'Yes' if checklist_data.has_mt103_and_202 else 'No' }}</span></div>
                        <div>AUD Payment</div>
                        <div><span class="chip {{ 'chip-fail' if checklist_data.is_aud_payment else 'chip-pass' }}">{{ 'Yes' if checklist_data.is_aud_payment else 'No' }}</span></div>
                        <div>Amendment Sent</div>
                        <div><span class="chip {{ 'chip-fail' if checklist_data.amendment_previously_sent else 'chip-pass' }}">{{ 'Yes' if checklist_data.amendment_previously_sent else 'No' }}</span></div>
                        <div>CBA FCA Return</div>
                        <div><span class="chip {{ 'chip-fail' if checklist_data.returned_due_to_cba_fca else 'chip-pass' }}">{{ 'Yes' if checklist_data.returned_due_to_cba_fca else 'No' }}</span></div>
                        <div>No Funds Due Charges</div>
                        <div><span class="chip {{ 'chip-fail' if checklist_data.no_funds_due_to_charges else 'chip-pass' }}">{{ 'Yes' if checklist_data.no_funds_due_to_charges else 'No' }}</span></div>
                        <div>Return Reason Clear</div>
                        <div><span class="chip {{ 'chip-pass' if checklist_data.return_reason_clear else 'chip-fail' }}">{{ 'Yes' if checklist_data.return_reason_clear else 'No' }}</span></div>
                        <div>Manual Review Required</div>
                        <div><span class="chip {{ 'chip-fail' if result.manual_review_required else 'chip-pass' }}">{{ 'Yes' if result.manual_review_required else 'No' }}</span></div>
                    </div>
                    </details>

                    <!-- Nested: Nostro -->
                    <details>
                      <summary style="font-weight: 600">üè¶ Nostro</summary>
                      <div class="kv-grid" style="margin-top:8px;">
                        <div>Match Found</div>
                        <div><span class="chip {{ 'chip-pass' if (ver and ver.nostro_result and ver.nostro_result.found) else 'chip-fail' }}">{{ 'Yes' if (ver and ver.nostro_result and ver.nostro_result.found) else 'No' }}</span></div>
                        <div>Match Type</div>
                        <div><span class="chip chip-info">{{ ver.nostro_result.match_type if (ver and ver.nostro_result) else 'none' }}</span></div>
                        <div>Nostro Entry</div>
                        <div><span class="chip chip-info">{{ ver.nostro_result.nostro_entry if (ver and ver.nostro_result and ver.nostro_result.nostro_entry) else 'N/A' }}</span></div>
                    </div>
                    </details>

                    <!-- Nested: Refund -->
                    <details>
                      <summary style="font-weight: 600">üí∞ Refund (D1‚ÄìD9)</summary>
                      <div class="kv-grid" style="margin-top:8px;">
                        <div>Can Process</div>
                        <div><span class="chip {{ 'chip-pass' if refund_data.can_process else 'chip-fail' }}">{{ 'Yes' if refund_data.can_process else 'No' }}</span></div>
                        <div>Final Action</div>
                        <div><span class="chip chip-info">{{ refund_data.reason or 'N/A' }}</span></div>
                        <div>Account Operations</div>
                        <div><span class="chip chip-info">{{ (result.refund_processing.refund_decision.account_operations | length) if (result.refund_processing and result.refund_processing.refund_decision and result.refund_processing.refund_decision.account_operations) else ((result.refund_decision.account_operations | length) if (result.refund_decision and result.refund_decision.account_operations) else 0) }}</span></div>
                        <div>Credit Account IBAN</div>
                        <div><span class="chip chip-info">{{ (result.refund_processing.refund_decision.credit_account_iban if (result.refund_processing and result.refund_processing.refund_decision and result.refund_processing.refund_decision.credit_account_iban) else (result.refund_decision.credit_account_iban if (result.refund_decision and result.refund_decision.credit_account_iban) else (result.parsed_data.pacs008.dbtr_iban if (result.parsed_data and result.parsed_data.pacs008) else 'N/A'))) }}</span></div>
                  </div>
                    </details>
                </div>
              </details>
                
                <!-- Verifier Agent Details -->
              <details class="template-item">
                <summary style="font-weight: 600">
                    ‚úÖ Verifier Agent ‚Äî
                    <span class="chip {{ 'chip-pass' if ver.reconciliation_ok else 'chip-fail' }}">
                      {{ 'PASS' if ver.reconciliation_ok else 'FAIL' }}
                    </span>
                </summary>
                <div class="template-content">
                  <div class="kv-grid">
                      <div>Reconciliation OK</div>
                      <div><span class="chip {{ 'chip-pass' if ver.reconciliation_ok else 'chip-fail' }}">{{ 'Yes' if ver.reconciliation_ok else 'No' }}</span></div>
                      <div>Sequence OK</div>
                      <div><span class="chip {{ 'chip-pass' if checks.sequence_ok else 'chip-fail' }}">{{ 'Yes' if checks.sequence_ok else 'No' }}</span></div>
                      <div>Cross Checks OK</div>
                      <div><span class="chip {{ 'chip-pass' if checks.cross_checks_ok else 'chip-fail' }}">{{ 'Yes' if checks.cross_checks_ok else 'No' }}</span></div>
                      <div>CSV Validation OK</div>
                      <div><span class="chip {{ 'chip-pass' if checks.csv_validation_ok else 'chip-fail' }}">{{ 'Yes' if checks.csv_validation_ok else 'No' }}</span></div>
                      <div>Non Branch OK</div>
                      <div><span class="chip {{ 'chip-pass' if checks.non_branch_ok else 'chip-fail' }}">{{ 'Yes' if checks.non_branch_ok else 'No' }}</span></div>
                      <div>Sanctions OK</div>
                      <div><span class="chip {{ 'chip-pass' if checks.sanctions_ok else 'chip-fail' }}">{{ 'Yes' if checks.sanctions_ok else 'No' }}</span></div>
                      <div>FX Loss Within Limit</div>
                      <div><span class="chip {{ 'chip-pass' if checks.fx_loss_within_limit else 'chip-fail' }}">{{ 'Yes' if checks.fx_loss_within_limit else 'No' }}</span></div>
                      <div>Nostro Match Found</div>
                      <div><span class="chip {{ 'chip-pass' if checks.nostro_match_found else 'chip-fail' }}">{{ 'Yes' if checks.nostro_match_found else 'No' }}</span></div>
                      <div>Process Flow OK</div>
                      <div><span class="chip {{ 'chip-pass' if checks.process_flow_ok else 'chip-fail' }}">{{ 'Yes' if checks.process_flow_ok else 'No' }}</span></div>
                  </div>
                </div>
              </details>
                
                <!-- Communications Agent Details -->
              <details class="template-item">
                <summary style="font-weight: 600">
                    üìß Communications Agent ‚Äî
                  <span class="chip chip-pass">PREPARED</span>
                </summary>
                <div class="template-content">
                  <div class="kv-grid">
                      <div>Templates Generated</div>
                      <div><span class="chip chip-info">{{ (comm_data.templates | length) if comm_data.templates else 0 }}</span></div>
                      <div>Customer Notification</div>
                      <div><span class="chip chip-info">{{ comm_data.customer_notification.status if comm_data.customer_notification else ('SENT' if (result.summary and result.summary.can_process) else 'N/A') }}</span></div>
                      <div>Branch Advisory</div>
                      <div><span class="chip chip-info">{{ comm_data.branch_advisory.status if comm_data.branch_advisory else ('Prepared' if (result.summary and result.summary.can_process) else 'N/A') }}</span></div>
                      <div>Ops Advisory Priority</div>
                      <div><span class="chip chip-info">{{ comm_data.ops_advisory.priority if comm_data.ops_advisory else 'Normal' }}</span></div>
                      <div>Decision Summary</div>
                      <div><span class="chip chip-info">{{ (result.summary.reason if result.summary else (refund_data.reason if refund_data else 'N/A')) }}</span></div>
                      <div>Account Ops Count</div>
                      <div><span class="chip chip-info">{{ (result.summary.account_operations_count if result.summary and result.summary.account_operations_count is not none else ((result.refund_decision.account_operations | length) if result.refund_decision and result.refund_decision.account_operations else 0)) }}</span></div>
          </div>
        </div>
              </details>
              </div>
            </div>
          </div>
        </div>
        <div id="tab-graph" class="tab-panel">
          <div class="section" style="margin-top: 0">
            <h3>Interactive Agent Graph</h3>
            <p style="margin-bottom: 20px; color: #666;">Hover over each agent to see the data flowing through them</p>
            
            {% set elig = (result.investigation.eligibility if result.investigation else (result.investigator_eligibility or {})) %}
            {% set ver = (result.verifier_summary or (result.verification.verifier_summary if result.verification else {})) %}
            {% set checks = ver.checks or {} %}
            {% set fx_data = (result.fx_calculation or result.fx or {}) %}
            {% set checklist_data = (result.flow_checklist or result.checklist or {}) %}
            {% set refund_data = (result.refund_decision or {}) %}
            {% set comm_data = (result.communications.communication_templates if result.communications and result.communications.communication_templates else (result.communication_templates or {})) %}
            {% set nostro_data = (ver.nostro_result if ver and ver.nostro_result else (result.verification.nostro_result if result.verification else {})) %}
            
              <div id="graph-tooltip" class="graph-tooltip"></div>
            
            <div class="agentic-graph-container">
              <div class="agentic-graph">
                <!-- Logger Agent -->
                <div class="agent-node" data-agent="prep_logger">
                  <div class="node-content">
                    <div class="agent-icon">üìù</div>
                    <div class="agent-info">
                      <h4>Logger Agent</h4>
                      <p>Data Preparation</p>
                    </div>
                    <div class="agent-status">‚úì</div>
                  </div>
                </div>
                
                <!-- Arrow 1 -->
                <div class="flow-arrow">
                  <svg width="40" height="20" viewBox="0 0 40 20">
                    <defs>
                      <marker id="arrowhead" markerWidth="10" markerHeight="7" refX="9" refY="3.5" orient="auto">
                        <polygon points="0 0, 10 3.5, 0 7" fill="#666" />
                      </marker>
                    </defs>
                    <line x1="0" y1="10" x2="30" y2="10" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)" />
                  </svg>
                </div>
                
                <!-- Investigation Agent -->
                <div class="agent-node" data-agent="investigator">
                  <div class="node-content">
                    <div class="agent-icon">üîç</div>
                    <div class="agent-info">
                      <h4>Investigation Agent</h4>
                      <p>Eligibility & Validation</p>
                    </div>
                    <div class="agent-status">‚úì</div>
                  </div>
                </div>
                
                <!-- Arrow 2 -->
                <div class="flow-arrow">
                  <svg width="40" height="20" viewBox="0 0 40 20">
                    <line x1="0" y1="10" x2="30" y2="10" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)" />
                  </svg>
                </div>
                
                <!-- Actioning Agent -->
                <div class="agent-node main-agent" data-agent="actioning">
                  <div class="node-content">
                    <div class="agent-icon">‚öôÔ∏è</div>
                    <div class="agent-info">
                      <h4>Actioning Agent</h4>
                      <p>Processing & Decision</p>
                    </div>
                    <div class="agent-status">‚úì</div>
                  </div>
                  
                  <!-- Sub-agents -->
                  <div class="sub-agents-container">
                    <div class="sub-agent" data-agent="fx">
                      <div class="sub-icon">üí±</div>
                      <div class="sub-label">FX</div>
                    </div>
                    <div class="sub-agent" data-agent="checklist">
                      <div class="sub-icon">‚úÖ</div>
                      <div class="sub-label">Checklist</div>
                    </div>
                    <div class="sub-agent" data-agent="nostro">
                      <div class="sub-icon">üè¶</div>
                      <div class="sub-label">Nostro</div>
                    </div>
                    <div class="sub-agent" data-agent="refund">
                      <div class="sub-icon">üí∞</div>
                      <div class="sub-label">Refund</div>
                    </div>
                  </div>
                </div>
                
                <!-- Arrow 3 -->
                <div class="flow-arrow">
                  <svg width="40" height="20" viewBox="0 0 40 20">
                    <line x1="0" y1="10" x2="30" y2="10" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)" />
                  </svg>
                </div>
                
                <!-- Verifier Agent -->
                <div class="agent-node" data-agent="verifier">
                  <div class="node-content">
                    <div class="agent-icon">‚úÖ</div>
                    <div class="agent-info">
                      <h4>Verifier Agent</h4>
                      <p>Final Validation</p>
                    </div>
                    <div class="agent-status">‚úì</div>
                  </div>
                </div>
                
                <!-- Arrow 4 -->
                <div class="flow-arrow">
                  <svg width="40" height="20" viewBox="0 0 40 20">
                    <line x1="0" y1="10" x2="30" y2="10" stroke="#666" stroke-width="2" marker-end="url(#arrowhead)" />
                  </svg>
                </div>
                
                <!-- Communications Agent -->
                <div class="agent-node" data-agent="communications">
                  <div class="node-content">
                    <div class="agent-icon">üìß</div>
                    <div class="agent-info">
                      <h4>Communications Agent</h4>
                      <p>Notifications</p>
                    </div>
                    <div class="agent-status">‚úì</div>
                  </div>
                </div>
              </div>
            </div>

            
            <script>
              // Tooltip functionality for agent nodes
              (function(){
                const tooltip = document.getElementById('graph-tooltip');
                if(!tooltip) return;
                
                const agentData = {
                  prep_logger: {
                    title: 'Logger Agent',
                    rows: [
                      ['Case ID', {{ (result.prep_logger.case_id if result.prep_logger else 'N/A') | tojson | safe }}],
                      ['Email Subject', {{ (result.prep_logger.email_payload.subject if (result.prep_logger and result.prep_logger.email_payload) else 'N/A') | tojson | safe }}],
                      ['Customer Email', {{ (result.prep_logger.email_payload.customer_email if (result.prep_logger and result.prep_logger.email_payload) else 'N/A') | tojson | safe }}],
                      ['Transaction Ref', {{ (result.prep_logger.email_payload.reference if (result.prep_logger and result.prep_logger.email_payload) else 'N/A') | tojson | safe }}],
                      ['Amount', {{ (result.prep_logger.email_payload.amount if (result.prep_logger and result.prep_logger.email_payload) else 'N/A') | tojson | safe }}],
                      ['Currency', {{ (result.prep_logger.email_payload.currency if (result.prep_logger and result.prep_logger.email_payload) else 'N/A') | tojson | safe }}],
                      ['Return Reason', {{ (result.prep_logger.email_payload.return_reason if (result.prep_logger and result.prep_logger.email_payload) else 'N/A') | tojson | safe }}],
                      ['Anonymized', {{ ('Yes' if (result.prep_logger and result.prep_logger.anonymized_data) else 'No') | tojson | safe }}]
                    ]
                  },
                  investigator: {
                    title: 'Investigation Agent',
                    rows: [
                      ['UETR', {{ (result.parsed_data.pacs004.uetr if result.parsed_data and result.parsed_data.pacs004 else '-') | tojson | safe }}],
                      ['E2E', {{ (result.parsed_data.pacs004.e2e if result.parsed_data and result.parsed_data.pacs004 else '-') | tojson | safe }}],
                      ['IBAN', {{ (result.parsed_data.pacs004.cdtr_iban if result.parsed_data and result.parsed_data.pacs004 else '-') | tojson | safe }}],
                      ['Return Reason', {{ (elig.reason or 'N/A') | tojson | safe }}],
                      ['Reason Info', {{ (elig.reason_info or 'N/A') | tojson | safe }}],
                      ['Auto Refund Eligible', {{ ('Yes' if elig.eligible_auto_refund else 'No') | tojson | safe }}],
                      ['Customer Valid', {{ ('Yes' if (result.investigation and result.investigation.csv_validation and result.investigation.csv_validation.ok) else 'No') | tojson | safe }}],
                      ['Cross Checks', {{ ('OK' if (result.investigation and result.investigation.cross_errors is defined and (result.investigation.cross_errors | length) == 0) else 'FAIL') | tojson | safe }}]
                    ]
                  },
                  actioning: {
                    title: 'Actioning Agent',
                    rows: [
                      ['FX Loss AUD', {{ ('$' ~ (result.fx_calculation.loss_aud if result.fx_calculation else 0)) | tojson | safe }}],
                      ['Exceeds $300', {{ ('Yes' if (result.fx_calculation and result.fx_calculation.exceeds_limit) else 'No') | tojson | safe }}],
                      ['FCA Account Found', {{ ('Yes' if (result.fx_calculation and result.fx_calculation.fca_account_found) else 'No') | tojson | safe }}],
                      ['Nostro Match', {{ ('Yes' if (ver and ver.nostro_result and ver.nostro_result.found) else 'No') | tojson | safe }}],
                      ['Manual Review', {{ ('Yes' if (result.flow_checklist and result.flow_checklist.manual_review_required) else 'No') | tojson | safe }}]
                    ]
                  },
                  refund: {
                    title: 'Refund Agent (D1-D9 Flow)',
                    rows: [
                      ['Can Process', {{ ('Yes' if (result.summary and result.summary.can_process) or (result.refund_decision and result.refund_decision.can_process) else 'No') | tojson | safe }}],
                      ['Final Action', {{ (result.summary.reason if result.summary else (result.refund_decision.reason if result.refund_decision else 'N/A')) | tojson | safe }}],
                      ['Account Operations', {{ (result.summary.account_operations_count if result.summary and result.summary.account_operations_count is not none else ((result.refund_decision.account_operations | length) if result.refund_decision and result.refund_decision.account_operations else 0)) | tojson | safe }}],
                      ['Credit Account IBAN', {{ (result.summary.credit_account_iban if result.summary and result.summary.credit_account_iban is not none else (result.refund_decision.credit_account_iban if result.refund_decision else 'N/A')) | tojson | safe }}]
                    ]
                  },
                  verifier: {
                    title: 'Verifier Agent',
                    rows: [
                      ['Reconciliation OK', {{ ('Yes' if (ver and ver.reconciliation_ok is defined and ver.reconciliation_ok) else 'No') | tojson | safe }}],
                      ['Sequence OK', {{ ('Yes' if (checks and checks.sequence_ok is defined and checks.sequence_ok) else 'No') | tojson | safe }}],
                      ['Cross Checks OK', {{ ('Yes' if (checks and checks.cross_checks_ok is defined and checks.cross_checks_ok) else 'No') | tojson | safe }}],
                      ['CSV Validation OK', {{ ('Yes' if (checks and checks.csv_validation_ok is defined and checks.csv_validation_ok) else 'No') | tojson | safe }}],
                      ['Sanctions OK', {{ ('Yes' if (checks and checks.sanctions_ok is defined and checks.sanctions_ok) else 'No') | tojson | safe }}],
                      ['FX Loss Within Limit', {{ ('Yes' if (checks and checks.fx_loss_within_limit is defined and checks.fx_loss_within_limit) else 'No') | tojson | safe }}],
                      ['Nostro Match Found', {{ ('Yes' if (checks and checks.nostro_match_found is defined and checks.nostro_match_found) else 'No') | tojson | safe }}],
                      ['Process Flow OK', {{ ('Yes' if (checks and checks.process_flow_ok is defined and checks.process_flow_ok) else 'No') | tojson | safe }}]
                    ]
                  },
                  communications: {
                    title: 'Communications Agent',
                    rows: [
                      ['Templates Generated', {{ ((comm_data.templates | length) if (comm_data and comm_data.templates is defined) else 0) | tojson | safe }}],
                      ['Customer Notification', {{ (comm_data.customer_notification if (comm_data and comm_data.customer_notification is defined) else 'N/A') | tojson | safe }}],
                      ['Branch Advisory', {{ (comm_data.branch_advisory if (comm_data and comm_data.branch_advisory is defined) else 'N/A') | tojson | safe }}],
                      ['Decision Summary', {{ (comm_data.decision_summary if (comm_data and comm_data.decision_summary is defined) else 'N/A') | tojson | safe }}]
                    ]
                  },
                  fx: {
                    title: 'FX Calculation',
                    rows: [
                      ['Original Amount', {{ (fx_data.original_amount if (fx_data and fx_data.original_amount is defined) else 'N/A') | tojson | safe }}],
                      ['Returned Amount', {{ (fx_data.returned_amount if (fx_data and fx_data.returned_amount is defined) else 'N/A') | tojson | safe }}],
                      ['Original AUD', {{ (fx_data.original_aud if (fx_data and fx_data.original_aud is defined) else 'N/A') | tojson | safe }}],
                      ['Returned AUD', {{ (fx_data.returned_aud if (fx_data and fx_data.returned_aud is defined) else 'N/A') | tojson | safe }}],
                      ['FX Loss AUD', {{ (fx_data.loss_aud if (fx_data and fx_data.loss_aud is defined) else 'N/A') | tojson | safe }}],
                      ['Exceeds $300', {{ ('Yes' if (fx_data and fx_data.exceeds_limit is defined and fx_data.exceeds_limit) else 'No') | tojson | safe }}],
                      ['FCA Account Found', {{ ('Yes' if (fx_data and fx_data.fca_account_found is defined and fx_data.fca_account_found) else 'No') | tojson | safe }}]
                    ]
                  },
                  checklist: {
                    title: 'Checklist Validation',
                    rows: [
                      ['Email Rejection', {{ ('Yes' if (checklist_data and checklist_data.email_rejection is defined and checklist_data.email_rejection) else 'No') | tojson | safe }}],
                      ['Correct Payment', {{ ('Yes' if (checklist_data and checklist_data.correct_payment is defined and checklist_data.correct_payment) else 'No') | tojson | safe }}],
                      ['Has MT103/202', {{ ('Yes' if (checklist_data and checklist_data.has_mt103_message is defined and checklist_data.has_mt103_message) else 'No') | tojson | safe }}],
                      ['AUD Payment', {{ ('Yes' if (checklist_data and checklist_data.is_aud_payment is defined and checklist_data.is_aud_payment) else 'No') | tojson | safe }}],
                      ['Amendment Sent', {{ ('Yes' if (checklist_data and checklist_data.amendment_previously_sent is defined and checklist_data.amendment_previously_sent) else 'No') | tojson | safe }}],
                      ['CBA FCA Return', {{ ('Yes' if (checklist_data and checklist_data.returned_due_to_cba_fca is defined and checklist_data.returned_due_to_cba_fca) else 'No') | tojson | safe }}],
                      ['No Funds Due Charges', {{ ('Yes' if (checklist_data and checklist_data.charges_prevent_return is defined and checklist_data.charges_prevent_return) else 'No') | tojson | safe }}],
                      ['Return Reason Clear', {{ ('Yes' if (checklist_data and checklist_data.return_reason_clear is defined and checklist_data.return_reason_clear) else 'No') | tojson | safe }}],
                      ['Manual Review Required', {{ ('Yes' if (checklist_data and checklist_data.manual_review_required is defined and checklist_data.manual_review_required) else 'No') | tojson | safe }}]
                    ]
                  },
                  nostro: {
                    title: 'Nostro Reconciliation',
                    rows: [
                      ['Match Found', {{ ('Yes' if (nostro_data and nostro_data.found is defined and nostro_data.found) else 'No') | tojson | safe }}],
                      ['Match Type', {{ (nostro_data.match_type if (nostro_data and nostro_data.match_type is defined) else 'N/A') | tojson | safe }}],
                      ['Statement ID', {{ (nostro_data.nostro_entry.statement_id if (nostro_data and nostro_data.nostro_entry is defined and nostro_data.nostro_entry.statement_id is defined) else 'N/A') | tojson | safe }}],
                      ['Value Date', {{ (nostro_data.nostro_entry.value_date if (nostro_data and nostro_data.nostro_entry is defined and nostro_data.nostro_entry.value_date is defined) else 'N/A') | tojson | safe }}],
                      ['Currency', {{ (nostro_data.nostro_entry.currency if (nostro_data and nostro_data.nostro_entry is defined and nostro_data.nostro_entry.currency is defined) else 'N/A') | tojson | safe }}],
                      ['Amount', {{ (nostro_data.nostro_entry.amount if (nostro_data and nostro_data.nostro_entry is defined and nostro_data.nostro_entry.amount is defined) else 'N/A') | tojson | safe }}],
                      ['DR/CR', {{ (nostro_data.nostro_entry.dr_cr if (nostro_data and nostro_data.nostro_entry is defined and nostro_data.nostro_entry.dr_cr is defined) else 'N/A') | tojson | safe }}]
                    ]
                  },
                  refund: {
                    title: 'Refund Processing (D1-D9)',
                    rows: [
                      ['Can Process', {{ ('Yes' if (refund_data and refund_data.can_process is defined and refund_data.can_process) else 'No') | tojson | safe }}],
                      ['Final Action', {{ (refund_data.reason if (refund_data and refund_data.reason is defined) else 'N/A') | tojson | safe }}],
                      ['Account Operations', {{ ((refund_data.account_operations | length) if (refund_data and refund_data.account_operations is defined) else 0) | tojson | safe }}],
                      ['Credit Account IBAN', {{ (refund_data.credit_account_iban if (refund_data and refund_data.credit_account_iban is defined) else 'N/A') | tojson | safe }}],
                      ['D1 Decision', {{ (refund_data.d1_d9_decisions.D1.decision if (refund_data and refund_data.d1_d9_decisions is defined and refund_data.d1_d9_decisions.D1 is defined and refund_data.d1_d9_decisions.D1.decision is defined) else 'N/A') | tojson | safe }}],
                      ['D2 Decision', {{ (refund_data.d1_d9_decisions.D2.decision if (refund_data and refund_data.d1_d9_decisions is defined and refund_data.d1_d9_decisions.D2 is defined and refund_data.d1_d9_decisions.D2.decision is defined) else 'N/A') | tojson | safe }}],
                      ['D3 Decision', {{ (refund_data.d1_d9_decisions.D3.decision if (refund_data and refund_data.d1_d9_decisions is defined and refund_data.d1_d9_decisions.D3 is defined and refund_data.d1_d9_decisions.D3.decision is defined) else 'N/A') | tojson | safe }}]
                    ]
                  }
                };
                
                function showTooltip(e, agentKey) {
                  const data = agentData[agentKey];
                  if (!data) return;
                  
                  let html = '<h4>' + data.title + '</h4>';
                  data.rows.forEach(function(row) {
                    html += '<div class="data-row">';
                    html += '<span class="data-label">' + row[0] + ':</span>';
                    html += '<span class="data-value">' + row[1] + '</span>';
                    html += '</div>';
                  });
                  
                  tooltip.innerHTML = html;
                  tooltip.style.left = (e.clientX + 15) + 'px';
                  tooltip.style.top = (e.clientY + 15) + 'px';
                  tooltip.style.display = 'block';
                }
                
                function hideTooltip() {
                  tooltip.style.display = 'none';
                }
                
                // Handle main agent nodes
                document.querySelectorAll('.agent-node').forEach(function(node) {
                  const agentKey = node.getAttribute('data-agent');
                  if (agentKey) {
                    node.addEventListener('mouseenter', function(e) { showTooltip(e, agentKey); });
                    node.addEventListener('mousemove', function(e) { 
                      tooltip.style.left = (e.clientX + 15) + 'px';
                      tooltip.style.top = (e.clientY + 15) + 'px';
                    });
                    node.addEventListener('mouseleave', hideTooltip);
                  }
                });
                
                // Handle sub-agent nodes
                document.querySelectorAll('.sub-agent').forEach(function(node) {
                  const agentKey = node.getAttribute('data-agent');
                  if (agentKey) {
                    node.addEventListener('mouseenter', function(e) { showTooltip(e, agentKey); });
                    node.addEventListener('mousemove', function(e) { 
                      tooltip.style.left = (e.clientX + 15) + 'px';
                      tooltip.style.top = (e.clientY + 15) + 'px';
                    });
                    node.addEventListener('mouseleave', hideTooltip);
                  }
                });
              })();
            </script>
          </div>
        </div>

        <!-- Detailed Process Overview Tab -->
        <div id="detailed-overview" class="tab-content">
          <!-- <div class="section">
            <h3>Detailed Process Overview</h3>
            <p>This section provides a comprehensive overview of the refund processing workflow, including all decision points and agent interactions.</p>
            
            <div class="info-grid">
              <div class="info-card">
                <h4>Process Flow</h4>
                <p>The refund processing follows a structured workflow through multiple agents, each responsible for specific validation and processing steps.</p>
              </div>
              
              <div class="info-card">
                <h4>Decision Points</h4>
                <p>Key decision points (D1-D9) determine the processing path and final outcome of each refund case.</p>
              </div>
              
              <div class="info-card">
                <h4>Agent Interactions</h4>
                <p>Each agent performs specific functions and passes data to subsequent agents in the workflow.</p>
              </div>
            </div>
          </div> -->
        </div>
        <div id="tab-comm" class="tab-panel">
          <div class="section" style="margin-top: 0">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
              <h3 style="margin: 0;">Communication</h3>
              <button id="regenerate-email-btn" class="back-button" style="margin: 0;">
                üîÑ Regenerate Mail
              </button>
            </div>
            
            {% set inv = result.investigation.eligibility or {} %}
            {% set csvv = result.investigation.csv_validation or {} %}
            {% set rec = csvv.record if csvv and csvv.record else {} %}
            {% set comm_notification = result.communication_templates.customer_notification if result.communication_templates else {} %}
            {% set to_email = comm_notification.email or rec.email or 'customer@example.com' %}
            {% set to_name = comm_notification.recipient or rec.account_holder_name or inv.customer_name or 'Customer' %}
            {% set uetr = result.parsed_data.pacs004.uetr if result.parsed_data.pacs004 else 'N/A' %}
            {% set rtr_ccy = result.parsed_data.pacs004.rtr_ccy if result.parsed_data.pacs004 else 'N/A' %}
            {% set rtr_amt = result.parsed_data.pacs004.rtr_amount if result.parsed_data.pacs004 else 'N/A' %}
            {% set rsn_code = (inv.reason or (result.parsed_data.pacs004.rsn if result.parsed_data.pacs004 else '')) %}
            {% set rsn_info = (result.parsed_data.pacs004.rsn_info if result.parsed_data.pacs004 else '') %}
            {% set reason_label_map = {'AC01':'Incorrect Account Number','AC04':'Account Closed','MS03':'Reason Not Specified','CURR':'Wrong Currency'} %}
            {% set reason_label = rsn_info or reason_label_map.get(rsn_code, rsn_code or 'N/A') %}
            {% set refund_ok = (result.summary and result.summary.can_process) %}
            {% set status_text = 'Refund Processed' if refund_ok else 'Refund Pending' %}
            {# try to resolve FX loss in AUD from multiple places, fallback to N/A #}
            {# Resolve FX loss (AUD) from multiple potential sources #}
            {% set fx_loss_aud =
              (result.fx_details.fx_loss_aud
                if result.fx_details and (result.fx_details.fx_loss_aud is not none)
                else (
                  result.investigation.eligibility.fx_loss_aud
                  if result.investigation and result.investigation.eligibility and (result.investigation.eligibility.fx_loss_aud is not none)
                  else (
                    result.investigation.eligibility.fx_loss_aud
                    if result.investigation.eligibility and (result.investigation.eligibility.fx_loss_aud is not none)
                    else (
                      result.fx_loss_aud
                      if (result.fx_loss_aud is not none)
                      else None
                    )
                  )
                )
              )
            %}
            {% set fx_loss_display = ('AUD ' ~ ('%.2f' % fx_loss_aud)) if fx_loss_aud is not none else 'N/A' %}
            
            {# Check if we have Gemini-generated email content #}
            {% set email_subject = comm_notification.subject or ('Refund Status ‚Äì Action Required for Transaction UETR ' ~ uetr) %}
            {% set email_html_body = comm_notification.html_body or '' %}
            {% set email_plain_body = comm_notification.body or '' %}
            {% set generated_by = comm_notification.generated_by or 'template' %}
            {% set run_id = result.run_id if result.run_id else (result.transaction_id if result.transaction_id else '') %}

            <div class="summary-card" style="border-left-color: #ffd700">
              <div id="email-container" style="background:#fff;border:1px solid #e9ecef;border-radius:12px;overflow:hidden">
                <div style="background:linear-gradient(90deg,#fff8dc,#ffffff);padding:14px 16px;border-bottom:1px solid #e9ecef">
                  <div style="display:grid;grid-template-columns:90px 1fr;row-gap:6px;column-gap:12px;font-size:14px;color:#2c3e50">
                    <div style="font-weight:600">To:</div>
                    <div>{{ to_name }} &lt;{{ to_email }}&gt;</div>
                    <div style="font-weight:600">From:</div>
                    <div>refunds@cba.com.au</div>
                    <div style="font-weight:600">Subject:</div>
                    <div id="email-subject">{{ email_subject }}</div>
                  </div>
                  {% if generated_by == 'gemini' %}
                  <div style="margin-top: 8px; font-size: 12px; color: #666;">
                    <span style="background: #e8f4fd; color: #1976d2; padding: 2px 8px; border-radius: 4px;">‚ú® Generated by Gemini AI</span>
                  </div>
                  {% endif %}
                </div>
                <div id="email-body" style="padding:16px 18px;color:#2c3e50;line-height:1.7">
                  <style>
                    #email-body p {
                      margin: 0 0 12px 0;
                    }
                    #email-body p:last-child {
                      margin-bottom: 0;
                    }
                    #email-body strong {
                      font-weight: 700;
                      color: #1a1a1a;
                    }
                    #email-body ul {
                      margin: 12px 0 12px 20px;
                      padding-left: 0;
                      list-style-type: disc;
                    }
                    #email-body li {
                      margin: 6px 0;
                      padding-left: 4px;
                    }
                    #email-body code {
                      background: #f5f5f5;
                      padding: 2px 6px;
                      border-radius: 3px;
                      font-family: 'Courier New', monospace;
                      font-size: 0.9em;
                    }
                    #email-body em {
                      font-style: italic;
                    }
                  </style>
                  {% if email_html_body %}
                    {{ email_html_body | safe }}
                  {% elif email_plain_body %}
                    <pre style="white-space: pre-wrap; font-family: inherit;">{{ email_plain_body }}</pre>
                  {% else %}
                    {# Fallback to static template #}
                    <p>Dear {{ to_name }},</p>
                    <p>We've reviewed your payment return request with UETR <strong>{{ uetr }}</strong> and found the following:</p>
                    <ul style="margin:0 0 12px 18px">
                      <li><strong>Return Amount</strong>: {{ rtr_ccy }} {{ rtr_amt }}</li>
                      <li><strong>Reason</strong>: {{ reason_label }}{% if rsn_code %} ({{ rsn_code }}){% endif %}</li>
                      <li><strong>FX Loss</strong>: {{ fx_loss_display }}</li>
                      <li><strong>Status</strong>: {{ status_text }}</li>
                    </ul>
                    <div style="margin:14px 0;padding:12px 14px;border-radius:10px;background:#fff3cd;border:1px solid #ffe69c;color:#7a5b00">
                      <div style="font-weight:700;margin-bottom:4px">Action Required</div>
                      <div>We are reviewing your case and will update you shortly.</div>
                    </div>
                    <p>If you have any questions or need support, please contact your relationship manager or reply to this email.</p>
                    <p>Sincerely,<br /><strong>CBA Refund Investigations Team</strong></p>
                  {% endif %}
                </div>
              </div>
              
              <div id="regenerate-status" style="margin-top: 12px; padding: 10px; border-radius: 6px; display: none;"></div>
            </div>
          </div>
        </div>

        </div>

        <!-- Enhanced Refund Processing -->
        {% if result.enhanced_refund_decision %}
        <div class="section legacy">
          <h3>Enhanced Refund Processing</h3>
          <div class="enhanced-refund-card">
            <div class="enhanced-header">
              <h4>üåç Foreign Currency Processing</h4>
              {% set enhanced = result.enhanced_refund_decision %}
              <div
                class="status-badge {% if enhanced.can_process %}success{% else %}error{% endif %}"
              >
                {% if enhanced.can_process %}‚úÖ Processed{% else %}‚ùå Failed{%
              endif %}
            </div>
            </div>

            {% if enhanced.processing_details %} {% set details =
            enhanced.processing_details %}

            <!-- Currency Decision -->
            {% if details.currency_decision %}
            <div class="processing-step">
              <h5>Currency Analysis</h5>
              <p>
                <strong>Currency:</strong> {{
                details.currency_decision.returned_currency }}
              </p>
              <p>
                <strong>Type:</strong> {% if
                details.currency_decision.is_foreign_currency %}Foreign
                Currency{% else %}Domestic (AUD){% endif %}
              </p>
            </div>
            {% endif %}

            <!-- Nostro Verification -->
            {% if details.nostro_result %}
            <div class="processing-step">
              <h5>Nostro Verification</h5>
              {% if details.nostro_result.found %}
              <p><strong>Status:</strong> ‚úÖ Nostro item found</p>
              {% if details.nostro_result.nostro_item %}
              <p>
                <strong>Nostro Account:</strong> {{
                details.nostro_result.nostro_item.nostro_account }}
              </p>
              {% endif %} {% else %}
              <p><strong>Status:</strong> ‚ùå Nostro item not found</p>
              <p><strong>Reason:</strong> {{ details.nostro_result.reason }}</p>
              {% endif %}
          </div>
            {% endif %}

            <!-- FCA Decision -->
            {% if details.fca_decision %}
            <div class="processing-step">
              <h5>FCA Account Processing</h5>
              {% if details.fca_decision.is_fca_refund %}
              <p><strong>Type:</strong> ‚úÖ FCA Refund</p>
              {% if details.fca_decision.fca_account %}
              <p>
                <strong>FCA Account:</strong> {{
                details.fca_decision.fca_account.account_number }}
              </p>
              {% endif %} {% else %}
              <p><strong>Type:</strong> Standard Refund</p>
              {% endif %}
        </div>
            {% endif %}

            <!-- Payment Processing -->
            {% if details.payment_result %}
            <div class="processing-step">
              <h5>Payment Processing</h5>
              {% if details.payment_result.success %}
              <p><strong>Status:</strong> ‚úÖ Payment processed</p>
              {% if details.payment_result.transaction %}
              <p>
                <strong>Transaction ID:</strong> {{
                details.payment_result.transaction.transaction_id }}
              </p>
              {% endif %} {% else %}
              <p><strong>Status:</strong> ‚ùå Payment failed</p>
              <p>
                <strong>Reason:</strong> {{ details.payment_result.reason }}
              </p>
              {% endif %}
            </div>
            {% endif %}

            <!-- Markets Case -->
            {% if details.markets_result %}
            <div class="processing-step">
              <h5>Markets Processing</h5>
              {% if details.markets_result.is_markets_case %}
              <p><strong>Type:</strong> üìà Markets Case</p>
              {% if details.markets_result.markets_case %}
              <p>
                <strong>Case Type:</strong> {{
                details.markets_result.markets_case.case_type }}
              </p>
              {% endif %} {% else %}
              <p><strong>Type:</strong> Standard Processing</p>
              {% endif %}
            </div>
            {% endif %}

            <!-- Case Management -->
            {% if details.case_result %}
            <div class="processing-step">
              <h5>Case Management</h5>
              {% if details.case_result.success %}
              <p><strong>Status:</strong> ‚úÖ Case processed</p>
              {% if details.case_result.qf_case %}
              <p>
                <strong>Case ID:</strong> {{ details.case_result.qf_case.case_id
                }}
              </p>
              {% endif %} {% else %}
              <p><strong>Status:</strong> ‚ùå Case processing failed</p>
              <p><strong>Reason:</strong> {{ details.case_result.reason }}</p>
              {% endif %}
            </div>
            {% endif %}

            <!-- Case Closure -->
            {% if details.closure_result %}
            <div class="processing-step">
              <h5>Case Closure</h5>
              {% if details.closure_result.success %}
              <p><strong>Status:</strong> ‚úÖ Case closed</p>
              {% if details.closure_result.closure %}
              <p>
                <strong>Final Status:</strong> {{
                details.closure_result.closure.case_status }}
              </p>
              <p>
                <strong>Notification:</strong> {{
                details.closure_result.closure.customer_notification }}
              </p>
              {% endif %} {% else %}
              <p><strong>Status:</strong> ‚ùå Closure failed</p>
              <p>
                <strong>Reason:</strong> {{ details.closure_result.reason }}
              </p>
              {% endif %}
            </div>
            {% endif %} {% endif %}
          </div>
        </div>
        {% endif %}

        <!-- Eligibility Check (Legacy - hidden) -->
        <div class="section legacy">
          <h3>Eligibility Assessment</h3>
          <div class="eligibility-grid">
            <div
              class="eligibility-item {% if not (result.investigation.eligibility and result.investigation.eligibility.is_aud_refund) %}pass{% else %}fail{% endif %}"
            >
              <h4>AUD Refund</h4>
              <p>
                {% if not (result.investigation.eligibility and
                result.investigation.eligibility.is_aud_refund) %}‚úì Not AUD{%
                else %}‚úó AUD{% endif %}
              </p>
            </div>
            <div
              class="eligibility-item {% if result.investigation.eligibility and result.investigation.eligibility.fx_loss_within_limit %}pass{% else %}fail{% endif %}"
            >
              <h4>FX Loss Limit</h4>
              <p>
                {% if result.investigation.eligibility and
                result.investigation.eligibility.fx_loss_within_limit %}‚úì Within
                Limit{% else %}‚úó Exceeds Limit{% endif %}
              </p>
            </div>
            <div
              class="eligibility-item {% if result.investigation.eligibility and result.investigation.eligibility.non_branch %}pass{% else %}fail{% endif %}"
            >
              <h4>Channel Type</h4>
              <p>
                {% if result.investigation.eligibility and
                result.investigation.eligibility.non_branch %}‚úì Non-branch{% else
                %}‚úó Branch Channel{% endif %}
              </p>
            </div>
            <div
              class="eligibility-item {% if result.investigation.eligibility and result.investigation.eligibility.sanctions_ok %}pass{% else %}fail{% endif %}"
            >
              <h4>Sanctions</h4>
              <p>
                {% if result.investigation.eligibility and
                result.investigation.eligibility.sanctions_ok %}‚úì Passed{% else
                %}‚úó Failed{% endif %}
              </p>
            </div>

            <!-- Merged Verification as cards -->
            <div
              class="eligibility-item {% if checks and checks.sequence_ok %}pass{% else %}fail{% endif %}"
            >
              <h4>Sequence Check</h4>
              <p>
                {% if checks and checks.sequence_ok %}‚úì Passed{% else
                %}‚úó Failed{% endif %}
              </p>
            </div>
            <div
              class="eligibility-item {% if checks and checks.cross_checks_ok %}pass{% else %}fail{% endif %}"
            >
              <h4>Cross-Message Validation</h4>
              <p>
                {% if checks and checks.cross_checks_ok %}‚úì Passed{%
                else %}‚úó Failed{% endif %}
              </p>
            </div>
            <div
              class="eligibility-item {% if checks and checks.csv_validation_ok %}pass{% else %}fail{% endif %}"
            >
              <h4>Customer Validation</h4>
              <p>
                {% if checks and checks.csv_validation_ok %}‚úì
                Passed{% else %}‚úó Failed{% endif %}
              </p>
            </div>

            {% set checks = ver.process_flow_checks if ver else [] %} {% set skip_keys =
            ['is_aud_payment', 'loss_amount_gt_300'] %} {% for c in checks %} {%
            if c.key not in skip_keys %}
            <div class="eligibility-item {{ 'pass' if c.ok else 'fail' }}">
              <h4>{{ c.label }}</h4>
              <p>{% if c.actual %}‚úì Yes{% else %}‚úó No{% endif %}</p>
            </div>
            {% endif %} {% endfor %}

            <!-- Enhanced Refund Processing Checks -->
            {% if result.enhanced_refund_decision and
            result.enhanced_refund_decision.processing_details %} {% set
            enhanced = result.enhanced_refund_decision %} {% set details =
            enhanced.processing_details %}

            <!-- Foreign Currency Processing -->
            <div
              class="eligibility-item {% if details.currency_decision and details.currency_decision.is_foreign_currency %}pass{% else %}info{% endif %}"
            >
              <h4>Foreign Currency Detection</h4>
              <p>
                {% if details.currency_decision and
                details.currency_decision.is_foreign_currency %}‚úì Foreign
                Currency{% else %}‚ÑπÔ∏è Domestic{% endif %}
              </p>
          </div>

            <!-- Swift Intellimatch Integration -->
            {% if details.currency_decision and
            details.currency_decision.is_foreign_currency %}
            <div
              class="eligibility-item {% if result.swift_intellimatch_documents %}pass{% else %}fail{% endif %}"
            >
              <h4>Swift Intellimatch Documents</h4>
              <p>
                {% if result.swift_intellimatch_documents %}‚úì Documents
                Attached{% else %}‚úó Documents Missing{% endif %}
              </p>
        </div>
            {% endif %}

            <!-- Nostro Verification -->
            <div
              class="eligibility-item {% if details.nostro_result and details.nostro_result.found %}pass{% else %}fail{% endif %}"
            >
              <h4>Nostro Item Verification</h4>
              <p>
                {% if details.nostro_result and details.nostro_result.found %}‚úì
                Nostro Found{% else %}‚úó Nostro Not Found{% endif %}
              </p>
            </div>

            <!-- FCA Account Processing -->
            <div
              class="eligibility-item {% if details.fca_decision and details.fca_decision.is_fca_refund %}pass{% else %}info{% endif %}"
            >
              <h4>FCA Account Processing</h4>
              <p>
                {% if details.fca_decision and
                details.fca_decision.is_fca_refund %}‚úì FCA Refund{% else %}‚ÑπÔ∏è
                Standard Refund{% endif %}
              </p>
            </div>

            <!-- CommSee Verification -->
            {% if details.fca_decision and details.fca_decision.is_fca_refund %}
            <div
              class="eligibility-item {% if result.commsee_verification and result.commsee_verification.account_holder_match %}pass{% else %}fail{% endif %}"
            >
              <h4>CommSee Account Match</h4>
              <p>
                {% if result.commsee_verification and
                result.commsee_verification.account_holder_match %}‚úì Account
                Match{% else %}‚úó No Match{% endif %}
              </p>
            </div>
            {% endif %}

            <!-- Payment Processing -->
            <div
              class="eligibility-item {% if details.payment_result and details.payment_result.success %}pass{% else %}fail{% endif %}"
            >
              <h4>Payment System Processing</h4>
              <p>
                {% if details.payment_result and details.payment_result.success
                %}‚úì Payment Processed{% else %}‚úó Payment Failed{% endif %}
              </p>
            </div>

            <!-- Markets Case Handling -->
            <div
              class="eligibility-item {% if details.markets_result and details.markets_result.is_markets_case %}info{% else %}pass{% endif %}"
            >
              <h4>Markets Case Processing</h4>
              <p>
                {% if details.markets_result and
                details.markets_result.is_markets_case %}‚ÑπÔ∏è Markets Case{% else
                %}‚úì Standard Case{% endif %}
              </p>
            </div>

            <!-- Case Management -->
            <div
              class="eligibility-item {% if details.case_result and details.case_result.success %}pass{% else %}fail{% endif %}"
            >
              <h4>QF Case Management</h4>
              <p>
                {% if details.case_result and details.case_result.success %}‚úì
                Case Created{% else %}‚úó Case Failed{% endif %}
              </p>
            </div>

            <!-- Case Closure -->
            <div
              class="eligibility-item {% if details.closure_result and details.closure_result.success %}pass{% else %}fail{% endif %}"
            >
              <h4>Case Closure</h4>
              <p>
                {% if details.closure_result and details.closure_result.success
                %}‚úì Case Closed{% else %}‚úó Closure Failed{% endif %}
              </p>
            </div>
            {% endif %}
          </div>
        </div>

        <!-- FX Details (Legacy - hidden) -->
        <div class="section legacy">
          <h3>FX Details</h3>
          <div class="summary-card" style="border-left-color: #ffd700">
            <div class="info-row">
              <span class="info-label">Currency Received</span>
              <span class="info-value"
                >{{ result.investigation.eligibility.returned_currency if
                result.investigation.eligibility else '-' }}
              </span>
            </div>
            <div class="info-row">
              <span class="info-label">Original Amount</span>
              <span class="info-value"
                >{{ result.investigation.eligibility.original_currency if
                result.investigation.eligibility else 'N/A' }} {{ '%.2f' %
                (result.investigation.eligibility.original_amount or 0) if
                result.investigation.eligibility else '0.00' }}</span
              >
            </div>
            <div class="info-row">
              <span class="info-label">Returned Amount</span>
              <span class="info-value"
                >{{ result.investigation.eligibility.returned_currency if
                result.investigation.eligibility else 'N/A' }} {{ '%.2f' %
                (result.investigation.eligibility.returned_amount or 0) if
                result.investigation.eligibility else '0.00' }}</span
              >
            </div>
            <div class="info-row">
              <span class="info-label">Original Amount (AUD)</span>
              <span class="info-value"
                >{{ 'AUD ' + ('%.2f' %
                result.investigation.eligibility.original_amount_aud) if
                result.investigation.eligibility and
                result.investigation.eligibility.original_amount_aud is not none
                else 'N/A' }}</span
              >
            </div>
            <div class="info-row">
              <span class="info-label">Returned Amount (AUD)</span>
              <span class="info-value"
                >{{ 'AUD ' + ('%.2f' %
                result.investigation.eligibility.returned_amount_aud) if
                result.investigation.eligibility and
                result.investigation.eligibility.returned_amount_aud is not none
                else 'N/A' }}</span
              >
            </div>
            <div class="info-row">
              <span class="info-label"
                >FX Rate ({{ result.investigation.eligibility.original_currency
                if result.investigation.eligibility else '-' }} ‚Üí AUD)</span
              >
              <span class="info-value"
                >{{ ('%.6f' % result.investigation.eligibility.original_aud_rate)
                if result.investigation.eligibility and
                result.investigation.eligibility.original_aud_rate is not none
                else 'N/A' }}</span
              >
            </div>
            <div class="info-row">
              <span class="info-label">FX Loss</span>
              <span class="info-value"
                >AUD {{ '%.2f' % (result.investigation.eligibility.fx_loss_aud or
                0) if result.investigation.eligibility else '0.00' }}</span
              >
            </div>
          </div>
        </div>

        <!-- Reconciliation Summary (Legacy - hidden) -->
        <div class="section legacy">
          <h3>Reconciliation</h3>
          <div
            class="decision-card {% if result.verifier_summary and result.verifier_summary.reconciliation_ok %}processed{% else %}failed{% endif %}"
          >
            <div class="decision-icon">
              {% if result.verifier_summary and
              result.verifier_summary.reconciliation_ok %} ‚úÖ {% else %} ‚ùå {%
              endif %}
            </div>
            <div class="decision-title">
              {% if result.verifier_summary and
              result.verifier_summary.reconciliation_ok %} All checks passed {%
              else %} Attention required {% endif %}
            </div>
            <div class="decision-details">
              {% if result.verifier_summary and
              result.verifier_summary.reconciliation_ok %} All verification and
              compliance checks are successful. {% else %} {% set labelmap = {
              'sequence_ok': 'Sequence Check', 'cross_checks_ok': 'Cross-Message
              Validation', 'csv_validation_ok': 'Customer Validation',
              'non_branch_ok': 'Channel Type', 'sanctions_ok': 'Sanctions',
              'fx_loss_within_limit': 'FX Loss Limit', 'process_flow_ok':
              'Process Compliance' } %} {% set flow_failed =
              result.verifier_summary.process_flow_checks | selectattr('ok',
              'equalto', False) | list if result.verifier_summary else [] %} {%
              set flow_failed_keys = flow_failed | map(attribute='key') | list
              %}
              <div>Failed checks:</div>
              <ul>
                {# List generic checks, skipping process_flow_ok and FX Loss
                Limit if a specific flow loss item failed #} {% if
                result.verifier_summary and result.verifier_summary.checks %} {%
                for k, v in result.verifier_summary.checks.items() %} {% if not
                v %} {% if k == 'process_flow_ok' %} {# skip generic umbrella #}
                {% elif k == 'fx_loss_within_limit' and 'loss_amount_gt_300' in
                flow_failed_keys %} {# skip generic FX failure when specific
                flow failure exists #} {% else %}
                <li>{{ labelmap.get(k, k) }}</li>
                {% endif %} {% endif %} {% endfor %} {% endif %} {# List
                specific failing process-flow items #} {% for c in flow_failed
                %}
                <li>{{ c.label }}</li>
                {% endfor %}
              </ul>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- Communications (Legacy - hidden) -->
        <div class="section legacy">
          <h3>Communication Templates</h3>
          {% for line in result.communication_templates %}
          <div class="communication-item">{{ line }}</div>
          {% endfor %}
        </div>

        <!-- Audit Trail (Legacy - hidden) -->
        <div class="section legacy">
          <h3>Audit Trail</h3>
          <div class="audit-timeline">
            {% for e in result.audit_events %}
            <div class="audit-item" data-actor="{{ e.actor }}">
              <div class="audit-time">{{ e.ts }}</div>
              <div
                class="audit-actor modal-trigger"
                style="cursor: pointer; text-decoration: underline"
              >
                {{ e.actor|title }} Agent
              </div>
              <div class="audit-action">{{ e.action|title }}</div>
            </div>
            {% endfor %}
          </div>
        </div>
      </div>

      <!-- Agent Details Modal -->
      <div
        id="agentModal"
        style="
          position: fixed;
          inset: 0;
          display: none;
          background: rgba(10, 15, 30, 0.55);
          backdrop-filter: blur(2px);
          z-index: 9999;
        "
      >
        <div
          style="
            width: 920px;
            max-width: calc(100% - 48px);
            height: 78vh;
            max-height: 840px;
            margin: 64px auto;
            background: #ffffff;
            border-radius: 14px;
            box-shadow: 0 24px 64px rgba(0, 0, 0, 0.25);
            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #e9ecef;
          "
        >
          <div
            style="
              padding: 18px 22px;
              background: linear-gradient(135deg, #2c3e50 0%, #3a506b 100%);
              color: #fff;
              display: flex;
              justify-content: space-between;
              align-items: center;
              letter-spacing: 0.2px;
            "
          >
            <div id="agentModalTitle" style="font-weight: 600; font-size: 18px">
              Agent Details
            </div>
            <button
              id="agentModalClose"
              style="
                background: rgba(255, 255, 255, 0.12);
                border: 1px solid rgba(255, 255, 255, 0.25);
                color: #fff;
                font-size: 20px;
                cursor: pointer;
                border-radius: 8px;
                width: 36px;
                height: 36px;
                display: flex;
                align-items: center;
                justify-content: center;
              "
              title="Close"
            >
              √ó
            </button>
          </div>
          <div
            style="
              padding: 18px 22px;
              overflow: auto;
              flex: 1 1 auto;
              font-size: 15px;
              line-height: 1.5;
              color: #2c3e50;
              background: #fafbfc;
            "
          >
            <div id="agentModalBody"></div>
          </div>
          <div
            style="
              padding: 14px 22px;
              background: #f1f3f5;
              border-top: 1px solid #e9ecef;
              display: flex;
              justify-content: flex-end;
              gap: 10px;
            "
          >
            <button
              id="agentModalCloseBottom"
              style="
                background: #2c3e50;
                color: #fff;
                border: none;
                padding: 10px 16px;
                border-radius: 8px;
                font-weight: 600;
                cursor: pointer;
              "
            >
              Close
            </button>
          </div>
        </div>
      </div>

      <!-- Hidden templates for agent details -->
      <div id="tpl-investigator" style="display: none">
        <h4>üîç Investigator Agent - Transaction Analysis</h4>
        <p>
          <strong>Primary Role:</strong> Comprehensive transaction investigation
          and eligibility assessment
        </p>

        <h5>üìã Data Extraction & Validation</h5>
        <ul>
          <li>
            <strong>PACS Message Parsing:</strong> Extract UETR, End-to-End ID,
            amounts, and customer details
          </li>
          <li>
            <strong>Cross-Message Verification:</strong> Ensure consistency
            between PACS.004 and PACS.008
          </li>
          <li>
            <strong>Customer Validation:</strong> Verify account holder against
            CSV registry
          </li>
        </ul>

        <h5>üí∞ Financial Analysis</h5>
        <ul>
          <li>
            <strong>Currency Analysis:</strong> Determine if transaction
            involves foreign currency
          </li>
          <li>
            <strong>FX Loss Calculation:</strong> Compute foreign exchange loss
            in AUD
          </li>
          <li>
            <strong>Amount Reconciliation:</strong> Compare original vs returned
            amounts
          </li>
        </ul>

        <h5>üéØ Eligibility Assessment</h5>
        <ul>
          <li>
            <strong>Channel Type Check:</strong> Verify non-branch transaction
            eligibility
          </li>
          <li>
            <strong>Sanctions Screening:</strong> Ensure compliance with
            sanctions requirements
          </li>
          <li>
            <strong>FX Loss Limit:</strong> Check if loss exceeds AUD 300
            threshold
          </li>
          <li>
            <strong>Return Reason Analysis:</strong> Analyze return codes (AC01,
            AC04, MS03, CURR, etc.) and required actions
          </li>
        </ul>

        <h5>üìä Key Verifications Performed</h5>
        <div class="verification-grid">
          <div class="verification-item">
            <strong>UETR:</strong>
            <span class="verification-value"
              >e8b2f9c4-0e7d-4b8a-8c7c-4f5d6e7f8a9b</span
            >
          </div>
          <div class="verification-item">
            <strong>Currency:</strong>
            <span class="verification-value">EUR (Foreign Currency)</span>
          </div>
          <div class="verification-item">
            <strong>FX Loss:</strong>
            <span class="verification-value">AUD 53.28 (Within Limit)</span>
          </div>
          <div class="verification-item">
            <strong>Channel:</strong>
            <span class="verification-value">Non-branch ‚úÖ</span>
          </div>
          <div class="verification-item">
            <strong>Sanctions:</strong>
            <span class="verification-value">Passed ‚úÖ</span>
          </div>
          <div class="verification-item">
            <strong>Eligibility:</strong>
            <span class="verification-value">Auto-refund eligible ‚úÖ</span>
          </div>
        </div>

        <h4>Key Results</h4>
        <div class="agent-key-results"></div>
      </div>
      <div id="tpl-verifier" style="display: none">
        <h4>‚úÖ Verifier Agent - Compliance & Validation</h4>
        <p>
          <strong>Primary Role:</strong> Comprehensive verification and
          compliance checking
        </p>

        <h5>üîÑ Process Flow Validation</h5>
        <ul>
          <li>
            <strong>Sequence Verification:</strong> Ensure proper agent
            execution order
          </li>
          <li>
            <strong>Cross-Message Validation:</strong> Verify consistency across
            PACS messages
          </li>
          <li>
            <strong>Data Integrity Check:</strong> Confirm all required fields
            are present and valid
          </li>
        </ul>

        <h5>üìã Compliance Verification</h5>
        <ul>
          <li>
            <strong>CSV Validation:</strong> Verify customer account against
            registry
          </li>
          <li>
            <strong>Policy Compliance:</strong> Check channel type, sanctions,
            and FX limits
          </li>
          <li>
            <strong>Process Adherence:</strong> Ensure all mandated procedures
            are followed
          </li>
        </ul>

        <h5>üéØ Quality Assurance</h5>
        <ul>
          <li>
            <strong>Decision Validation:</strong> Verify eligibility decisions
            are correct
          </li>
          <li>
            <strong>Risk Assessment:</strong> Evaluate transaction risk factors
          </li>
          <li>
            <strong>Audit Trail:</strong> Ensure complete documentation for
            compliance
          </li>
        </ul>

        <h5>üìä Verification Results</h5>
        <div class="verification-grid">
          <div class="verification-item">
            <strong>Sequence Check:</strong>
            <span class="verification-value">Passed ‚úÖ</span>
          </div>
          <div class="verification-item">
            <strong>Cross-Message Validation:</strong>
            <span class="verification-value">Passed ‚úÖ</span>
          </div>
          <div class="verification-item">
            <strong>CSV Validation:</strong>
            <span class="verification-value">Passed ‚úÖ</span>
          </div>
          <div class="verification-item">
            <strong>Process Compliance:</strong>
            <span class="verification-value">All checks passed ‚úÖ</span>
          </div>
          <div class="verification-item">
            <strong>Reconciliation Status:</strong>
            <span class="verification-value">Successful ‚úÖ</span>
          </div>
        </div>

        <h4>Key Results</h4>
        <div class="agent-key-results"></div>
      </div>
      <div id="tpl-refund" style="display: none">
        <h4>üí∞ Refund Agent - Complete Processing</h4>
        <p>
          <strong>Primary Role:</strong> Comprehensive refund processing with
          enhanced foreign currency handling
        </p>

        <h5>üîÑ Standard Refund Processing</h5>
        <ul>
          <li>
            <strong>Eligibility Evaluation:</strong> Assess transaction
            eligibility for auto-refund
          </li>
          <li>
            <strong>Account Status Check:</strong> Verify destination account is
            active
          </li>
          <li>
            <strong>Return Reason Handling:</strong>
            {% set reason_code = (result.investigation.eligibility or {}).reason
            or 'UNKNOWN' %} {% if reason_code in ['AC01', 'AC04'] %} Locate
            alternate active IBAN for {{ 'incorrect' if reason_code == 'AC01'
            else 'closed' }} accounts {% elif reason_code == 'MS03' %} Manual
            review required for unspecified return reason {% elif reason_code ==
            'CURR' %} Manual review required for currency mismatch {% else %}
            Process according to return reason requirements {% endif %}
          </li>
          <li>
            <strong>Refund Decision:</strong> Set processing decision and target
            account
          </li>
        </ul>

        <h5>üåç Enhanced Refund Processing (8-Step Flow)</h5>
        <div class="enhanced-flow">
          <div class="flow-step">
            <strong>Step 1:</strong>
            <span class="step-title">Foreign Currency Detection</span>
            <div class="step-detail">‚úÖ EUR detected as foreign currency</div>
          </div>
          <div class="flow-step">
            <strong>Step 2:</strong>
            <span class="step-title">Swift Intellimatch Documents</span>
            <div class="step-detail">
              ‚úÖ Swift Confirmation & Supporting Documents attached
            </div>
          </div>
          <div class="flow-step">
            <strong>Step 3:</strong>
            <span class="step-title">Nostro Item Verification</span>
            <div class="step-detail">
              ‚úÖ Nostro item found: NOSTRO-EUR-20241201-003
            </div>
          </div>
          <div class="flow-step">
            <strong>Step 4:</strong>
            <span class="step-title">FCA Refund Decision</span>
            <div class="step-detail">‚ÑπÔ∏è Standard refund (not FCA)</div>
          </div>
          <div class="flow-step">
            <strong>Step 5:</strong>
            <span class="step-title">CommSee System Actions</span>
            <div class="step-detail">‚ÑπÔ∏è Not applicable (standard refund)</div>
          </div>
          <div class="flow-step">
            <strong>Step 6:</strong>
            <span class="step-title">Payment System Operations</span>
            <div class="step-detail">
              ‚úÖ Payment processed with nostro reference
            </div>
          </div>
          <div class="flow-step">
            <strong>Step 7:</strong>
            <span class="step-title">Markets Case Handling</span>
            <div class="step-detail">
              ‚úÖ Standard case (not Markets-related)
            </div>
          </div>
          <div class="flow-step">
            <strong>Step 8:</strong>
            <span class="step-title">Case Management & Closure</span>
            <div class="step-detail">
              ‚úÖ QF case created and closed with notifications
            </div>
          </div>
        </div>

        <h5>üìä Processing Results</h5>
        <div class="verification-grid">
          <div class="verification-item">
            <strong>Refund Decision:</strong>
            <span class="verification-value">Processed Successfully ‚úÖ</span>
          </div>
          <div class="verification-item">
            <strong>Target Account:</strong>
            <span class="verification-value">DE89370400440532013002</span>
          </div>
          <div class="verification-item">
            <strong>Amount:</strong>
            <span class="verification-value">EUR 970.00</span>
          </div>
          <div class="verification-item">
            <strong>Enhanced Processing:</strong>
            <span class="verification-value">8-step flow completed ‚úÖ</span>
          </div>
        </div>

        <h4>Decision</h4>
        <div class="agent-key-results"></div>
      </div>
      <div id="tpl-communications" style="display: none">
        <h4>üìû Communications Agent - Customer Notifications</h4>
        <p>
          <strong>Primary Role:</strong> Generate appropriate customer and
          branch communications
        </p>

        <h5>üìã Communication Generation</h5>
        <ul>
          <li>
            <strong>Status-Based Messaging:</strong> Create messages based on
            refund processing status
          </li>
          <li>
            <strong>Customer Advisories:</strong> Prepare notifications for
            successful refunds
          </li>
          <li>
            <strong>Branch Communications:</strong> Generate operational
            advisories for branches
          </li>
          <li>
            <strong>Failure Notifications:</strong> Create detailed failure
            explanations when needed
          </li>
        </ul>

        <h5>üìä Message Templates</h5>
        <div class="message-templates">
          <div class="template-item">
            <strong>‚úÖ Success Template:</strong>
            <div class="template-content">
              "Refund processed successfully to the specified account.
              Reference: UETR/E2E."
            </div>
          </div>
          <div class="template-item">
            <strong>‚ö†Ô∏è Pending Template:</strong>
            <div class="template-content">
              "Refund pending due to failed verification/compliance checks."
            </div>
          </div>
          <div class="template-item">
            <strong>‚ùå Failure Template:</strong>
            <div class="template-content">
              "Reconciliation failed: [Specific reason]. Manual review
              required."
            </div>
          </div>
        </div>

        <h5>üìà Communication Results</h5>
        <div class="verification-grid">
          <div class="verification-item">
            <strong>Customer Message:</strong>
            <span class="verification-value">Generated ‚úÖ</span>
          </div>
          <div class="verification-item">
            <strong>Branch Advisory:</strong>
            <span class="verification-value">Prepared ‚úÖ</span>
          </div>
          <div class="verification-item">
            <strong>Reference Details:</strong>
            <span class="verification-value">UETR/E2E included</span>
          </div>
        </div>

        <h4>Prepared Messages</h4>
        <div class="agent-key-results"></div>
      </div>
      <div id="tpl-log_verifier" style="display: none">
        <h4>üìã Log Verifier Agent - Audit Trail Management</h4>
        <p>
          <strong>Primary Role:</strong> Comprehensive audit trail verification
          and log management
        </p>

        <h5>üîç Audit Trail Verification</h5>
        <ul>
          <li>
            <strong>Log Integrity Check:</strong> Verify all audit events are
            properly recorded
          </li>
          <li>
            <strong>Sequence Validation:</strong> Ensure proper chronological
            order of events
          </li>
          <li>
            <strong>Completeness Check:</strong> Confirm all required audit
            events are present
          </li>
          <li>
            <strong>Data Consistency:</strong> Validate audit data matches
            processing results
          </li>
        </ul>

        <h5>üìä Audit Events Tracked</h5>
        <div class="audit-events">
          <div class="audit-event">
            <strong>üîç Investigator:</strong>
            <span class="event-status">Evaluated</span>
            <div class="event-detail">
              Transaction analysis and eligibility assessment completed
            </div>
          </div>
          <div class="audit-event">
            <strong>‚úÖ Verifier:</strong>
            <span class="event-status">Verified</span>
            <div class="event-detail">
              Compliance and validation checks completed
            </div>
          </div>
          <div class="audit-event">
            <strong>üí∞ Refund:</strong>
            <span class="event-status">Processed</span>
            <div class="event-detail">
              Refund processing and 8-step enhanced flow completed
            </div>
          </div>
          <div class="audit-event">
            <strong>üìû Communications:</strong>
            <span class="event-status">Prepared</span>
            <div class="event-detail">
              Customer and branch notifications generated
            </div>
          </div>
        </div>

        <h5>üìà Audit Results</h5>
        <div class="verification-grid">
          <div class="verification-item">
            <strong>Log Integrity:</strong>
            <span class="verification-value">Verified ‚úÖ</span>
          </div>
          <div class="verification-item">
            <strong>Event Sequence:</strong>
            <span class="verification-value">Correct ‚úÖ</span>
          </div>
          <div class="verification-item">
            <strong>Completeness:</strong>
            <span class="verification-value">All events present ‚úÖ</span>
          </div>
          <div class="verification-item">
            <strong>Timestamp Accuracy:</strong>
            <span class="verification-value">Validated ‚úÖ</span>
          </div>
        </div>

        <h4>Log Events</h4>
        <div class="agent-key-results"></div>
      </div>

      <script>
        /* eslint-disable */
        (function () {
          const modal = document.getElementById("agentModal");
          const title = document.getElementById("agentModalTitle");
          const body = document.getElementById("agentModalBody");
          const closeBtn = document.getElementById("agentModalClose");
          const closeBtnBottom = document.getElementById("agentModalCloseBottom");

          // Per-agent payload (from server state)
          const agentPayload = {
            investigator: {{ (result.investigation.eligibility or {}) | tojson | safe }},
            verifier: {{ (result.verifier_summary or {}) | tojson | safe }},
            refund: {{ (result.summary or {}) | tojson | safe }},
            communications: {{ (result.communication_templates or []) | tojson | safe }},
            log_verifier: {{ (result.audit_events or []) | tojson | safe }}
          };

          function openModal(actor) {
            const key = (actor || "").toLowerCase();
            let tplId = null;
            if (key === "investigator") tplId = "tpl-investigator";
            else if (key === "verifier") tplId = "tpl-verifier";
            else if (key === "refund") tplId = "tpl-refund";
            else if (key === "communications") tplId = "tpl-communications";
            else if (
              key === "log_verifier" ||
              key === "logverifier" ||
              key === "logger"
            )
              tplId = "tpl-log_verifier";
            else tplId = "tpl-investigator";
            const tpl = document.getElementById(tplId);
            title.textContent =
              (actor || "Agent")
                .toString()
                .replace(/_/g, " ")
                .replace(/\b\w/g, (c) => c.toUpperCase()) + " - Details";
            body.innerHTML = tpl ? tpl.innerHTML : "<p>No details available.</p>";

            // Insert data payload into .agent-key-results
            const container = body.querySelector('.agent-key-results');
            if (container) {
              const payload = agentPayload[key] ?? null;
              const pre = document.createElement('pre');
              pre.style.whiteSpace = 'pre-wrap';
              pre.style.background = '#ffffff';
              pre.style.border = '1px solid #e9ecef';
              pre.style.borderRadius = '8px';
              pre.style.padding = '12px 14px';
              pre.style.fontSize = '14px';
              pre.style.lineHeight = '1.5';
              pre.textContent = payload != null ? JSON.stringify(payload, null, 2) : 'No data available.';
              container.appendChild(pre);
            }

            modal.style.display = "block";
          }

          document
            .querySelectorAll(".audit-item .modal-trigger")
            .forEach((el) => {
              el.addEventListener("click", function () {
                const container = this.closest('.audit-item');
                const actor = container ? container.getAttribute('data-actor') : null;
                openModal(actor);
              });
            });
          function closeModal(){ modal.style.display = 'none'; }
          closeBtn.addEventListener("click", closeModal);
          closeBtnBottom.addEventListener("click", closeModal);
          modal.addEventListener("click", (e) => {
            if (e.target === modal) { closeModal(); }
          });
        })();
      </script>
      <script>
        // Simple tabs controller
        (function () {
          const btns = document.querySelectorAll(".tab-btn");
          const panels = document.querySelectorAll(".tab-panel");
          function activate(id) {
            btns.forEach((b) =>
              b.classList.toggle("active", b.getAttribute("data-tab") === id)
            );
            panels.forEach((p) => p.classList.toggle("active", p.id === id));
          }
          btns.forEach((b) =>
            b.addEventListener("click", () =>
              activate(b.getAttribute("data-tab"))
            )
          );
          // Default
          activate("tab-workflow");
        })();
      </script>
      <!-- Agent Flow Diagram (Legacy - hidden) -->
      <div class="section legacy">
        <h3>Agent Flow</h3>
        {% set elig = result.investigation.eligibility or {} %} {% set checks =
        (result.verifier_summary.checks if result.verifier_summary else {}) %}
        {% set csvv = result.investigation.csv_validation or {} %} {% set csv_ok
        = csvv.ok if csvv is mapping else False %} {% set eligible =
        elig.eligible_auto_refund %} {% set reason_action =
        (elig.reason_analysis.action if elig.reason_analysis else None) %} {%
        set alt_needed = (reason_action == 'alternate_account') %} {% set
        original_iban = result.parsed_data.pacs004.cdtr_iban if result.parsed_data.pacs004
        else '' %} {% set credit_iban =
        result.summary.credit_account_iban if result.summary
        else '' %} {% set alt_found = alt_needed and result.summary and
        result.summary.can_process and credit_iban and credit_iban !=
        original_iban %} {% set verifier_ok = checks.sequence_ok and
        checks.cross_checks_ok and checks.csv_validation_ok and
        (result.verifier_summary.reconciliation_ok if result.verifier_summary
        else False) %} {% set refund_ok = result.summary.can_process if
        result.summary else False %} {% set comms_ok =
        (result.communication_templates|length) > 0 %} {% set logs_ok =
        (result.audit_events|length) > 0 %}
        <div style="margin-top: 10px; overflow: auto">
          <svg
            width="100%"
            height="auto"
            viewBox="0 0 1300 340"
            xmlns="http://www.w3.org/2000/svg"
            style="
              max-width: 100%;
              width: 100%;
              min-width: 1200px;
              height: auto;
              border: 1px solid #eee;
              border-radius: 6px;
              background: #fafafa;
            "
            preserveAspectRatio="xMidYMin meet"
          >
            <!-- Nodes -->
            <rect
              x="30"
              y="30"
              width="160"
              height="40"
              rx="8"
              fill="{{ '#f8fff9' if csv_ok else '#fff8f8' }}"
              stroke="{{ '#28a745' if csv_ok else '#dc3545' }}"
            />
            <text
              x="110"
              y="55"
              text-anchor="middle"
              font-family="Segoe UI, Arial"
              font-size="14"
            >
              Investigator
            </text>

            <polygon
              points="275,50 315,30 355,50 315,70"
              fill="{{ '#f8fff9' if eligible else '#f8d7da' }}"
              stroke="{{ '#28a745' if eligible else '#dc3545' }}"
            />
            <text
              x="315"
              y="55"
              text-anchor="middle"
              font-family="Segoe UI, Arial"
              font-size="12"
            >
              
            </text>

            <rect
              x="430"
              y="30"
              width="160"
              height="40"
              rx="8"
              fill="{{ '#f8fff9' if verifier_ok else '#fff8f8' }}"
              stroke="{{ '#28a745' if verifier_ok else '#dc3545' }}"
            />
            <text
              x="510"
              y="55"
              text-anchor="middle"
              font-family="Segoe UI, Arial"
              font-size="14"
            >
              Verifier
            </text>

            <polygon
              points="675,50 715,30 755,50 715,70"
              fill="{{ '#f8fff9' if (not alt_needed or alt_found) else '#fff3cd' }}"
              stroke="{{ '#28a745' if (not alt_needed or alt_found) else '#ffc107' }}"
            />
            <text
              x="715"
              y="55"
              text-anchor="middle"
              font-family="Segoe UI, Arial"
              font-size="12"
            >
              
            </text>

            <rect
              x="830"
              y="30"
              width="160"
              height="40"
              rx="8"
              fill="{{ '#f8fff9' if refund_ok else '#fff3cd' }}"
              stroke="{{ '#28a745' if refund_ok else '#ffc107' }}"
            />
            <text
              x="910"
              y="55"
              text-anchor="middle"
              font-family="Segoe UI, Arial"
              font-size="14"
            >
              Refund
            </text>

            <!-- Enhanced Refund Processing -->
            {% if result.enhanced_refund_decision %} {% set enhanced_ok =
            result.enhanced_refund_decision.can_process if
            result.enhanced_refund_decision else False %}
            <rect
              x="1050"
              y="30"
              width="180"
              height="40"
              rx="8"
              fill="{{ '#fff8dc' if enhanced_ok else '#fff3cd' }}"
              stroke="{{ '#ffd700' if enhanced_ok else '#ffc107' }}"
            />
            <text
              x="1140"
              y="55"
              text-anchor="middle"
              font-family="Segoe UI, Arial"
              font-size="14"
            >
              Enhanced Refund
            </text>
            {% endif %}

            <!-- Alternate decision: 'Alternate IBAN Found?' as diamond -->
            <polygon
              points="715,120 810,140 715,160 620,140"
              fill="{{ '#f8fff9' if alt_found else '#fff3cd' }}"
              stroke="{{ '#28a745' if alt_found else '#ffc107' }}"
            />
            <text
              x="715"
              y="144"
              text-anchor="middle"
              font-family="Segoe UI, Arial"
              font-size="12"
            >
              
            </text>

            <!-- Manual follow-up node (shown, dim when not needed) -->
            <rect
              x="620"
              y="200"
              width="190"
              height="36"
              rx="8"
              fill="#fff3cd"
              stroke="#ffc107"
              opacity="{{ '1' if (alt_needed and not alt_found) else '0.4' }}"
            />
            <text
              x="715"
              y="222"
              text-anchor="middle"
              font-family="Segoe UI, Arial"
              font-size="12"
              fill="#856404"
              opacity="{{ '1' if (alt_needed and not alt_found) else '0.4' }}"
            >
              
            </text>

            <!-- Communications and Logger -->
            <rect
              x="430"
              y="200"
              width="190"
              height="40"
              rx="8"
              fill="{{ '#f8fff9' if comms_ok else '#fff8f8' }}"
              stroke="{{ '#28a745' if comms_ok else '#dc3545' }}"
            />
            <text
              x="525"
              y="225"
              text-anchor="middle"
              font-family="Segoe UI, Arial"
              font-size="14"
            >
              Communications
            </text>

            <rect
              x="980"
              y="200"
              width="190"
              height="40"
              rx="8"
              fill="{{ '#f8fff9' if logs_ok else '#fff8f8' }}"
              stroke="{{ '#28a745' if logs_ok else '#dc3545' }}"
            />
            <text
              x="1075"
              y="225"
              text-anchor="middle"
              font-family="Segoe UI, Arial"
              font-size="14"
            >
              Log Verifier
            </text>

            <!-- Arrows main path -->
            <line
              x1="190"
              y1="50"
              x2="275"
              y2="50"
              stroke="{{ '#28a745' if eligible else '#dc3545' }}"
              marker-end="url(#arrow)"
            />
            <line
              x1="355"
              y1="50"
              x2="430"
              y2="50"
              stroke="{{ '#28a745' if verifier_ok else '#dc3545' }}"
              marker-end="url(#arrow)"
            />
            <line
              x1="590"
              y1="50"
              x2="675"
              y2="50"
              stroke="{{ '#28a745' if (not alt_needed or alt_found) else '#ffc107' }}"
              marker-end="url(#arrow)"
            />
            <line
              x1="755"
              y1="50"
              x2="830"
              y2="50"
              stroke="{{ '#28a745' if refund_ok else '#ffc107' }}"
              marker-end="url(#arrow)"
            />

            <!-- Arrow from Refund to Enhanced Refund -->
            {% if result.enhanced_refund_decision %}
            <line
              x1="990"
              y1="50"
              x2="1050"
              y2="50"
              stroke="{{ '#ffd700' if result.enhanced_refund_decision and result.enhanced_refund_decision.can_process else '#ffc107' }}"
              marker-end="url(#arrow)"
            />
            {% endif %}

            <!-- Eligibility YES label -->
            <text
              x="370"
              y="42"
              font-size="11"
              font-family="Segoe UI, Arial"
              fill="#2c3e50"
            >
              
            </text>
            <!-- Eligibility NO path (falls through to manual) -->
            <path
              d="M315,70 C315,95 315,95 380,95 H510"
              fill="none"
              stroke="#dc3545"
            />
            <text
              x="320"
              y="90"
              font-size="11"
              font-family="Segoe UI, Arial"
              fill="#dc3545"
            >
              
            </text>

            <!-- AC04 Alt? YES branch to lookup -->
            <path d="M715,70 V120" fill="none" stroke="#28a745" />
            <text
              x="725"
              y="90"
              font-size="11"
              font-family="Segoe UI, Arial"
              fill="#28a745"
            >
              
            </text>
            <path
              d="M810,140 H920 V70"
              fill="none"
              stroke="#666"
              marker-end="url(#arrow)"
            />
            <text
              x="828"
              y="142"
              font-size="11"
              font-family="Segoe UI, Arial"
              fill="#555"
            >
              
            </text>

            <!-- Not found edge to manual follow-up -->
            <path
              d="M715,160 V200"
              fill="none"
              stroke="#666"
              opacity="{{ '1' if (alt_needed and not alt_found) else '0.2' }}"
              marker-end="url(#arrow)"
            />
            <text
              x="725"
              y="185"
              font-size="11"
              font-family="Segoe UI, Arial"
              fill="#555"
              opacity="{{ '1' if (alt_needed and not alt_found) else '0.2' }}"
            >
              
            </text>

            <!-- AC04 Alt? NO label -->
            <text
              x="785"
              y="42"
              font-size="11"
              font-family="Segoe UI, Arial"
              fill="#2c3e50"
            >
              
            </text>

            <!-- Refund to Communications & Logger (routed to avoid overlaps) -->
            <path
              d="M910,70 V110 H525 V200"
              fill="none"
              stroke="#666"
              marker-end="url(#arrow)"
            />
            <path
              d="M910,70 V130 H1075 V200"
              fill="none"
              stroke="#666"
              marker-end="url(#arrow)"
            />

            <!-- Data labels between agents -->
            <text
              x="235"
              y="40"
              font-size="11"
              font-family="Segoe UI, Arial"
              fill="#555"
            >
              
            </text>
            <text
              x="470"
              y="25"
              font-size="11"
              font-family="Segoe UI, Arial"
              fill="#555"
            >
              
            </text>
            <text
              x="600"
              y="25"
              font-size="11"
              font-family="Segoe UI, Arial"
              fill="#555"
            >
              
            </text>
            <text
              x="950"
              y="25"
              font-size="11"
              font-family="Segoe UI, Arial"
              fill="#555"
            >
              
            </text>

            <!-- Legend -->
            <rect
              x="30"
              y="200"
              width="280"
              height="40"
              rx="6"
              fill="#ffffff"
              stroke="#e0e0e0"
            />
            <!-- Agent legend as rounded rectangle -->
            <rect
              x="42"
              y="212"
              width="22"
              height="14"
              rx="4"
              fill="#e8f4fd"
              stroke="#3498db"
            />
            <text x="70" y="224" font-size="12" font-family="Segoe UI, Arial">
              Agent
            </text>
            <!-- Decision legend as diamond -->
            <polygon
              points="150,220 158,212 166,220 158,228"
              fill="#fff3cd"
              stroke="#ffc107"
            />
            <text x="175" y="224" font-size="12" font-family="Segoe UI, Arial">
              Decision
            </text>

            <!-- Arrow marker -->
            <defs>
              <marker
                id="arrow"
                markerWidth="10"
                markerHeight="8"
                refX="9"
                refY="4"
                orient="auto"
                markerUnits="strokeWidth"
              >
                <path d="M0,0 L10,4 L0,8 Z" fill="#666" />
              </marker>
            </defs>
          </svg>
        </div>
      </div>
    </div>
          </div>
        </div>

    <script>
      // Animate progress bar on page load
      document.addEventListener('DOMContentLoaded', function() {
        // Extract case_id from URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const caseIdFromUrl = urlParams.get('case_id');
        
        // Display case_id
        const caseIdDisplay = document.getElementById('case-id-display');
        if (caseIdFromUrl) {
          caseIdDisplay.textContent = caseIdFromUrl;
        } else {
          // Fallback to transaction_id or run_id
          const transactionId = '{{ result.transaction_id if result and result.transaction_id else "" }}';
          const runId = '{{ result.run_id if result else "" }}';
          caseIdDisplay.textContent = transactionId || runId || 'Loading...';
        }
        
        // Simulate agent processing completion
        const steps = document.querySelectorAll('.progress-step');
        const fill = document.getElementById('cylindricalProgressFill');
        
        // Check if this is a completed report (has run_id and mode is not in 'processing' state)
        const mode = '{{ mode }}';
        const runId = '{{ result.run_id if result else "" }}';
        const isCompletedReport = runId && mode !== 'processing' && mode !== 'inprogress';
        const isInProgress = mode === 'inprogress' || mode === 'processing';
        
        // Only show delays for in-progress reports
        if (isInProgress) {
          // Disable all steps initially
          steps.forEach(step => step.classList.add('disabled'));
          
          // Show delays for in-progress reports
          steps.forEach((step, index) => {
            setTimeout(() => {
              step.classList.remove('disabled');
              step.classList.add('completed');
              const progressPercentage = ((index + 1) / 6) * 100;
              fill.style.width = `${progressPercentage}%`;
              
              // Auto-select step 5 after all steps complete
              if (index === 5) {
                const step5 = document.getElementById('step-5');
                if (step5) {
                  step5.classList.add('active');
                  showInvestigationReport();
                }
                
                // Remove mode parameter from URL but keep case_id
                setTimeout(() => {
                  const url = new URL(window.location.href);
                  url.searchParams.delete('mode');
                  window.history.replaceState({}, '', url.toString());
                }, 500);
              }
            }, index * 1000);
          });
          
          return;
        }
        
        // For completed reports, show all steps as completed immediately
        steps.forEach((step, index) => {
          step.classList.add('completed');
        });
        fill.style.width = '100%';
        
        // Auto-select step 5
        const step5 = document.getElementById('step-5');
        if (step5) {
          step5.classList.add('active');
          showInvestigationReport();
        }
      });

      // Function to highlight clicked step
      function highlightStep(stepNumber) {
        // Remove active class from all steps
        document.querySelectorAll('.progress-step').forEach(step => {
          step.classList.remove('active');
        });
        
        // Add active class to clicked step
        const clickedStep = document.getElementById(`step-${stepNumber}`);
        if (clickedStep) {
          clickedStep.classList.add('active');
        }
      }

      // Function to show Logger Agent content
      function showLoggerContent() {
        highlightStep(1);
        
        // Hide all other agent contents
        document.getElementById('investigatorContent').style.display = 'none';
        document.getElementById('verifierContent').style.display = 'none';
        document.getElementById('communicationsContent').style.display = 'none';
        document.getElementById('caseFinalStatusContent').style.display = 'none';
        document.getElementById('investigationReportContent').style.display = 'none';
        document.getElementById('reportTabs').style.display = 'none';
        document.querySelectorAll('.tab-panel').forEach(panel => {
          panel.style.display = 'none';
        });
        
        // Always show logger content
        document.getElementById('loggerContent').style.display = 'block';
      }

      // Function to show Investigation Report content
      function showInvestigationReport() {
        highlightStep(5);
        
        // Hide all agent contents first
        document.getElementById('loggerContent').style.display = 'none';
        document.getElementById('investigatorContent').style.display = 'none';
        document.getElementById('verifierContent').style.display = 'none';
        document.getElementById('communicationsContent').style.display = 'none';
        document.getElementById('caseFinalStatusContent').style.display = 'none';
        
        const tabs = document.getElementById('reportTabs');
        const tabPanels = document.querySelectorAll('.tab-panel');
        
        // Always show report content
        document.getElementById('investigationReportContent').style.display = 'block';
        tabs.style.display = 'block';
        
        // Reset all tab panels to use CSS classes instead of inline styles
        tabPanels.forEach(panel => {
          panel.style.display = '';
          panel.classList.remove('active');
        });
        
        // Activate the first tab (tab-workflow)
        const firstTab = document.querySelector('[data-tab="tab-workflow"]');
        const firstPanel = document.getElementById('tab-workflow');
        if (firstTab && firstPanel) {
          firstTab.classList.add('active');
          firstPanel.classList.add('active');
        }
      }

      // Function to show Investigator Agent content
      function showInvestigatorContent() {
        highlightStep(2);
        
        // Hide all other agent contents
        document.getElementById('loggerContent').style.display = 'none';
        document.getElementById('verifierContent').style.display = 'none';
        document.getElementById('communicationsContent').style.display = 'none';
        document.getElementById('caseFinalStatusContent').style.display = 'none';
        document.getElementById('investigationReportContent').style.display = 'none';
        document.getElementById('reportTabs').style.display = 'none';
        document.querySelectorAll('.tab-panel').forEach(panel => {
          panel.style.display = 'none';
        });
        
        // Always show investigator content
        document.getElementById('investigatorContent').style.display = 'block';
      }

      // Function to show Verifier Agent content
      function showVerifierContent() {
        highlightStep(3);
        
        // Hide all other agent contents
        document.getElementById('loggerContent').style.display = 'none';
        document.getElementById('investigatorContent').style.display = 'none';
        document.getElementById('communicationsContent').style.display = 'none';
        document.getElementById('caseFinalStatusContent').style.display = 'none';
        document.getElementById('investigationReportContent').style.display = 'none';
        document.getElementById('reportTabs').style.display = 'none';
        document.querySelectorAll('.tab-panel').forEach(panel => {
          panel.style.display = 'none';
        });
        
        // Always show verifier content
        document.getElementById('verifierContent').style.display = 'block';
      }

      // Function to show Communications Agent content
      function showCommunicationsContent() {
        highlightStep(4);
        
        // Hide all other agent contents
        document.getElementById('loggerContent').style.display = 'none';
        document.getElementById('investigatorContent').style.display = 'none';
        document.getElementById('verifierContent').style.display = 'none';
        document.getElementById('caseFinalStatusContent').style.display = 'none';
        document.getElementById('investigationReportContent').style.display = 'none';
        document.getElementById('reportTabs').style.display = 'none';
        document.querySelectorAll('.tab-panel').forEach(panel => {
          panel.style.display = 'none';
        });
        
        // Always show communications content
        document.getElementById('communicationsContent').style.display = 'block';
      }

      // Function to show Case Final Status content
      function showCaseFinalStatus() {
        highlightStep(6);
        
        // Hide all other agent contents
        document.getElementById('loggerContent').style.display = 'none';
        document.getElementById('investigatorContent').style.display = 'none';
        document.getElementById('verifierContent').style.display = 'none';
        document.getElementById('communicationsContent').style.display = 'none';
        document.getElementById('investigationReportContent').style.display = 'none';
        document.getElementById('reportTabs').style.display = 'none';
        document.querySelectorAll('.tab-panel').forEach(panel => {
          panel.style.display = 'none';
        });
        
        // Always show case final status content
        document.getElementById('caseFinalStatusContent').style.display = 'block';
      }

      // Regenerate Email functionality
      document.addEventListener('DOMContentLoaded', function() {
        const regenerateBtn = document.getElementById('regenerate-email-btn');
        const statusDiv = document.getElementById('regenerate-status');
        const emailBody = document.getElementById('email-body');
        const emailSubject = document.getElementById('email-subject');
        
        if (!regenerateBtn) return;
        
        // Extract run_id from URL or page data
        function getRunId() {
          // Try to get from page data (Jinja2 template variable)
          {% set page_run_id = result.run_id if result and result.run_id else (result.transaction_id if result and result.transaction_id else '') %}
          const pageRunId = {{ page_run_id | tojson | safe }};
          if (pageRunId) return pageRunId;
          
          // Fallback to URL path
          const pathParts = window.location.pathname.split('/');
          const runIdFromPath = pathParts[pathParts.length - 1];
          if (runIdFromPath && runIdFromPath !== 'report') return runIdFromPath;
          
          // Fallback to URL query parameter
          const urlParams = new URLSearchParams(window.location.search);
          const caseIdFromUrl = urlParams.get('case_id');
          if (caseIdFromUrl) return caseIdFromUrl;
          
          return null;
        }
        
        regenerateBtn.addEventListener('click', async function() {
          const runId = getRunId();
          
          if (!runId) {
            statusDiv.style.display = 'block';
            statusDiv.style.background = '#f8d7da';
            statusDiv.style.color = '#721c24';
            statusDiv.textContent = 'Error: Could not determine run_id. Please refresh the page.';
            return;
          }
          
          // Show loading state
          regenerateBtn.disabled = true;
          regenerateBtn.textContent = '‚è≥ Regenerating...';
          statusDiv.style.display = 'block';
          statusDiv.style.background = '#fff3cd';
          statusDiv.style.color = '#856404';
          statusDiv.textContent = 'Generating new email with Gemini AI...';
          
          try {
            const response = await fetch('/api/regenerate-email', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
              },
              body: JSON.stringify({ run_id: runId })
            });
            
            const data = await response.json();
            
            if (data.success && data.email) {
              // Update email subject
              if (data.email.subject) {
                emailSubject.textContent = data.email.subject;
              }
              
              // Update email body
              if (data.email.html_body) {
                emailBody.innerHTML = data.email.html_body;
              } else if (data.email.body) {
                emailBody.innerHTML = '<pre style="white-space: pre-wrap; font-family: inherit;">' + data.email.body + '</pre>';
              }
              
              // Update Gemini badge if applicable
              const emailHeader = emailBody.closest('#email-container').querySelector('div[style*="background:linear-gradient"]');
              if (emailHeader && data.email.generated_by === 'gemini') {
                let badge = emailHeader.querySelector('span[style*="Generated by Gemini"]');
                if (!badge) {
                  const badgeDiv = document.createElement('div');
                  badgeDiv.style.marginTop = '8px';
                  badgeDiv.style.fontSize = '12px';
                  badgeDiv.style.color = '#666';
                  badgeDiv.innerHTML = '<span style="background: #e8f4fd; color: #1976d2; padding: 2px 8px; border-radius: 4px;">‚ú® Generated by Gemini AI</span>';
                  emailHeader.appendChild(badgeDiv);
                }
              }
              
              // Show success message
              statusDiv.style.background = '#d4edda';
              statusDiv.style.color = '#155724';
              statusDiv.textContent = '‚úÖ Email regenerated successfully!';
              
              // Hide success message after 3 seconds
              setTimeout(() => {
                statusDiv.style.display = 'none';
              }, 3000);
              
            } else {
              throw new Error(data.error || 'Failed to regenerate email');
            }
            
          } catch (error) {
            console.error('Error regenerating email:', error);
            statusDiv.style.background = '#f8d7da';
            statusDiv.style.color = '#721c24';
            statusDiv.textContent = '‚ùå Error: ' + (error.message || 'Failed to regenerate email. Please try again.');
          } finally {
            // Reset button state
            regenerateBtn.disabled = false;
            regenerateBtn.textContent = 'üîÑ Regenerate Mail';
          }
        });
      });
    </script>
  </body>
</html>
